<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FLUXODRIVER - Controle Financeiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FLUXODRIVER">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="FLUXODRIVER">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile PWA Optimizations */
        input, select, textarea {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
        
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Safe area for devices with notch */
        .safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Mobile navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1f2937;
            border-top: 1px solid #374151;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .mobile-content {
            padding-bottom: 80px;
        }
        
        .blue-button {
            background-color: #3483FA;
            color: white;
            padding: 10px 24px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            font-size: 16px;
            transition: background-color 0.3s;
            font-family: Arial, sans-serif;
        }
        .blue-button:hover {
            background-color: #2a68c8;
        }

        /* Onboarding Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
        }

        .onboarding-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #1f2937, #374151);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        .onboarding-tooltip::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }

        .onboarding-tooltip.bottom::before {
            top: -20px;
            left: 20px;
            border-bottom-color: #3b82f6;
        }

        .onboarding-tooltip.top::before {
            bottom: -20px;
            left: 20px;
            border-top-color: #3b82f6;
        }

        .onboarding-tooltip.right::before {
            left: -20px;
            top: 20px;
            border-right-color: #3b82f6;
        }

        .onboarding-tooltip.left::before {
            right: -20px;
            top: 20px;
            border-left-color: #3b82f6;
        }

        .onboarding-highlight {
            position: relative;
            z-index: 1002;
            border-radius: 8px;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.6), 0 0 20px rgba(59, 130, 246, 0.4);
            background: rgba(59, 130, 246, 0.1);
        }

        .onboarding-skip {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(31, 41, 55, 0.9);
            color: white;
            border: 1px solid #6b7280;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1003;
            font-size: 14px;
        }

        .onboarding-progress {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(31, 41, 55, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            z-index: 1003;
            font-size: 14px;
            border: 1px solid #6b7280;
        }

        .onboarding-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 font-sans text-white">
    <!-- P√°gina de Login -->
    <div id="loginPage" class="container mx-auto p-4 max-w-md flex items-center justify-center h-screen">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full border border-gray-700">
            <div class="flex items-center justify-center mb-6">
                <svg width="40" height="40" viewBox="0 0 100 100" class="mr-2">
                    <rect x="20" y="40" width="60" height="30" rx="5" fill="#2563EB"/>
                    <circle cx="30" cy="70" r="5" fill="#FFFFFF"/>
                    <circle cx="70" cy="70" r="5" fill="#FFFFFF"/>
                    <path d="M50 20 L60 30 L50 40 L40 30 Z" fill="#34D399"/>
                </svg>
                <h1 class="text-2xl font-bold text-white">FLUXODRIVER</h1>
            </div>
            
            <!-- FREE 48 HOURS Banner -->
            <div class="bg-green-900 border border-green-600 text-green-300 px-4 py-3 rounded mb-4 text-center">
                <div class="font-bold">üéâ GR√ÅTIS POR 48 HORAS!</div>
                <div class="text-sm">Cadastre-se e use todas as funcionalidades sem pagar nada</div>
            </div>
            
            <h2 class="text-lg font-semibold text-white mb-4 text-center">Login</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">Usu√°rio</label>
                <input type="text" id="username" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Digite seu usu√°rio">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">Senha</label>
                <input type="password" id="password" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Digite sua senha">
            </div>
            <button onclick="login()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Entrar</button>
            <button onclick="showRegister()" class="mt-2 w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition">Cadastrar</button>
            <div class="mt-2 text-center">
                <button onclick="subscribe()" class="blue-button">Assinar</button>
            </div>
            <p id="loginError" class="text-red-500 text-sm text-center mt-2 hidden"></p>
        </div>
    </div>

    <!-- P√°gina de Cadastro -->
    <div id="registerPage" class="container mx-auto p-4 max-w-md flex items-center justify-center h-screen hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full border border-gray-700">
            <div class="flex items-center justify-center mb-6">
                <svg width="40" height="40" viewBox="0 0 100 100" class="mr-2">
                    <rect x="20" y="40" width="60" height="30" rx="5" fill="#2563EB"/>
                    <circle cx="30" cy="70" r="5" fill="#FFFFFF"/>
                    <circle cx="70" cy="70" r="5" fill="#FFFFFF"/>
                    <path d="M50 20 L60 30 L50 40 L40 30 Z" fill="#34D399"/>
                </svg>
                <h1 class="text-2xl font-bold text-gray-800">FLUXODRIVER</h1>
            </div>
            
            <!-- FREE 48 HOURS Banner -->
            <div class="bg-green-900 border border-green-600 text-green-300 px-4 py-3 rounded mb-4 text-center">
                <div class="font-bold">üéâ GR√ÅTIS POR 48 HORAS!</div>
                <div class="text-sm">Cadastre-se e use todas as funcionalidades sem pagar nada</div>
            </div>
            
            <h2 class="text-lg font-semibold text-white mb-4 text-center">Cadastro</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">Usu√°rio</label>
                <input type="text" id="newUsername" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Escolha um usu√°rio">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">Telefone</label>
                <input type="tel" id="newPhone" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 11999887766">
                <p class="text-xs text-gray-400 mt-1">Apenas n√∫meros, sem espa√ßos ou s√≠mbolos</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">C√≥digo de Afiliado (Opcional)</label>
                <input type="text" id="affiliateCode" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: JOAO1234">
                <p class="text-xs text-gray-400 mt-1">Se algu√©m te indicou, insira o c√≥digo aqui</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300">Senha</label>
                <input type="password" id="newPassword" class="mt-1 p-2 w-full bg-gray-700 border border-gray-600 text-white rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Escolha uma senha">
            </div>
            <button onclick="register()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">Cadastrar</button>
            <button onclick="showLogin()" class="mt-2 w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition">Voltar ao Login</button>
            <p id="registerError" class="text-red-500 text-sm text-center mt-2 hidden"></p>
        </div>
    </div>

    <!-- P√°gina Principal -->
    <div id="mainPage" class="container mx-auto p-4 max-w-4xl mobile-content safe-area hidden">
        <!-- Cabe√ßalho com Logo e Slogan -->
        <div class="flex items-center justify-center mb-6">
            <svg width="40" height="40" viewBox="0 0 100 100" class="mr-2">
                <rect x="20" y="40" width="60" height="30" rx="5" fill="#475569"/>
                <circle cx="30" cy="70" r="5" fill="#F8FAFC"/>
                <circle cx="70" cy="70" r="5" fill="#F8FAFC"/>
                <path d="M50 20 L60 30 L50 40 L40 30 Z" fill="#64748B"/>
            </svg>
            <div>
                <h1 class="text-2xl font-bold text-slate-100">FLUXODRIVER</h1>
                <p class="text-sm text-slate-400">Controle Profissional: Todo KM Vale, Todo Ganho Conta.</p>
            </div>
        </div>

        <!-- Trial Timer -->
        <div id="trialTimer" class="bg-gradient-to-r from-emerald-600 to-blue-600 text-white py-3 px-4 rounded-lg mb-6 text-center shadow-lg border border-emerald-500">
            <div class="flex items-center justify-center space-x-3">
                <span class="animate-pulse text-lg">‚è∞</span>
                <div>
                    <div class="font-bold text-lg">Trial gratuito de 48h termina em:</div>
                    <div id="timeRemaining" class="text-2xl font-mono font-bold">--:--:--</div>
                </div>
                <button id="activateNowBtn" onclick="subscribePushinPay()" class="ml-4 bg-white text-emerald-600 px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition-colors shadow-md">
                    ATIVAR AGORA
                </button>
            </div>
        </div>

        <!-- Message area for trial info -->
        <div id="mainMessage" class="mb-4 hidden"></div>

        <!-- Simplified Focus Message -->
        <div class="bg-slate-800 p-4 rounded-lg mb-6 border border-slate-600">
            <h3 class="text-slate-100 font-semibold mb-2">üíº Controle Profissional Simplificado</h3>
            <p class="text-slate-300 text-sm">Sistema focado no essencial: registre seus ganhos, gastos e acompanhe seu desempenho como motorista profissional.</p>
        </div>

        <!-- Formul√°rio de Entrada -->
        <div class="bg-slate-900 p-6 rounded-xl shadow-2xl mb-6 border border-slate-700">
            <h2 class="text-lg font-semibold text-slate-100 mb-4">Adicionar Registro</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300">Quil√¥metros Rodados</label>
                    <input type="number" id="km" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 100" step="0.1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Horas Trabalhadas</label>
                    <input type="number" id="hours_worked" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 8.5" step="0.1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Ganhos 99 (R$)</label>
                    <input type="number" id="gross" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 150.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Ganhos Uber (R$)</label>
                    <input type="number" id="uber_earnings" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 120.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Outros Ganhos - Corridas Particulares (R$)</label>
                    <input type="number" id="tips" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 50.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Gastos com Gasolina (R$)</label>
                    <input type="number" id="fuel" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 50.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Gastos com Comida (R$)</label>
                    <input type="number" id="food" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 20.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Seguro/Aluguel do Carro (R$)</label>
                    <input type="number" id="insurance" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 100.00" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300">Outros Gastos (R$)</label>
                    <input type="number" id="other" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 30.00" step="0.01">
                </div>
            </div>
            <button id="addRecordBtn" onclick="addRecord()" class="mt-6 bg-gradient-to-r from-slate-600 to-slate-700 text-slate-100 px-6 py-3 rounded-lg hover:from-slate-700 hover:to-slate-800 transition-all transform hover:scale-105 shadow-lg">Adicionar Registro</button>
            <button onclick="logout()" class="mt-6 ml-3 bg-gradient-to-r from-red-800 to-red-900 text-red-100 px-6 py-3 rounded-lg hover:from-red-900 hover:to-red-950 transition-all transform hover:scale-105 shadow-lg">Sair</button>
        </div>



        <!-- Controle de Manuten√ß√£o e Multas -->
        <div class="bg-slate-900 p-6 rounded-xl shadow-2xl mb-6 border border-slate-700">
            <h2 class="text-lg font-semibold text-slate-100 mb-4">Controle de Manuten√ß√£o e Multas</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Manuten√ß√£o -->
                <div>
                    <h3 class="text-md font-medium text-slate-300 mb-3">Manuten√ß√£o</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Tipo de Manuten√ß√£o</label>
                            <select id="maintenance_type" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all">
                                <option value="">Selecione...</option>
                                <option value="Troca de √ìleo">Troca de √ìleo</option>
                                <option value="Revis√£o">Revis√£o</option>
                                <option value="Pneus">Pneus</option>
                                <option value="Freios">Freios</option>
                                <option value="Suspens√£o">Suspens√£o</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Custo (R$)</label>
                            <input type="number" id="maintenance_cost" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 150.00" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Observa√ß√µes</label>
                            <input type="text" id="maintenance_notes" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: Oficina XYZ">
                        </div>
                        <button onclick="addMaintenance()" class="w-full bg-gradient-to-r from-green-700 to-green-800 text-green-100 px-4 py-3 rounded-lg hover:from-green-800 hover:to-green-900 transition-all transform hover:scale-105 shadow-lg">Adicionar Manuten√ß√£o</button>
                    </div>
                </div>
                
                <!-- Multas -->
                <div>
                    <h3 class="text-md font-medium text-slate-300 mb-3">Multas</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Tipo de Infra√ß√£o</label>
                            <select id="fine_type" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all">
                                <option value="">Selecione...</option>
                                <option value="Velocidade">Excesso de Velocidade</option>
                                <option value="Estacionamento">Estacionamento Irregular</option>
                                <option value="Sinal">Avan√ßo de Sinal</option>
                                <option value="Celular">Uso de Celular</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Valor (R$)</label>
                            <input type="number" id="fine_amount" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: 195.23" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Local</label>
                            <input type="text" id="fine_location" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all" placeholder="Ex: Av. Paulista, 1000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Status</label>
                            <select id="fine_status" class="mt-1 p-3 w-full bg-slate-800 border border-slate-600 text-slate-100 rounded-lg focus:ring-slate-500 focus:border-slate-500 transition-all">
                                <option value="Pendente">Pendente</option>
                                <option value="Pago">Pago</option>
                                <option value="Contestado">Contestado</option>
                            </select>
                        </div>
                        <button onclick="addFine()" class="w-full bg-gradient-to-r from-red-700 to-red-800 text-red-100 px-4 py-3 rounded-lg hover:from-red-800 hover:to-red-900 transition-all transform hover:scale-105 shadow-lg">Adicionar Multa</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumo Semanal -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">Resumo Semanal</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <p class="text-sm text-gray-400">Total KM Rodados</p>
                    <p id="weeklyKm" class="text-lg font-bold text-white">0 km</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Ganhos Totais</p>
                    <p id="weeklyGross" class="text-lg font-bold text-white">R$ 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Lucro L√≠quido</p>
                    <p id="weeklyNet" class="text-lg font-bold text-white">R$ 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Varia√ß√£o Semanal</p>
                    <p id="weekPercentage" class="text-lg font-bold text-white">0%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Custo por KM</p>
                    <p id="weeklyCostPerKm" class="text-lg font-bold text-orange-400">R$ 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Ganho por Hora</p>
                    <p id="weeklyEarningsPerHour" class="text-lg font-bold text-green-400">R$ 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Efici√™ncia (KM/L)</p>
                    <p id="weeklyEfficiency" class="text-lg font-bold text-blue-400">0.0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Horas Trabalhadas</p>
                    <p id="weeklyHours" class="text-lg font-bold text-purple-400">0h</p>
                </div>
            </div>
            <p id="motivationalMessage" class="text-sm text-gray-300 text-center"></p>
        </div>

        <!-- Ranking dos Dias da Semana -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">üèÜ Ranking dos Dias da Semana</h2>
            <div id="weeklyRanking" class="space-y-2">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>

        <!-- An√°lise Mensal -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">üìä Comparativo Mensal</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <p class="text-sm text-gray-400">M√™s Atual</p>
                    <p id="currentMonthNet" class="text-xl font-bold text-green-400">R$ 0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-400">M√™s Anterior</p>
                    <p id="previousMonthNet" class="text-xl font-bold text-gray-300">R$ 0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-400">Varia√ß√£o</p>
                    <p id="monthlyVariation" class="text-xl font-bold">0%</p>
                </div>
            </div>
        </div>

        <!-- Tabela de Registros -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-lg font-semibold text-white mb-4">Registros</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="p-2 text-sm font-medium text-gray-300">Data</th>
                            <th class="p-2 text-sm font-medium text-gray-300">KM</th>
                            <th class="p-2 text-sm font-medium text-gray-300">Ganhos Totais</th>
                            <th class="p-2 text-sm font-medium text-gray-300">Gastos</th>
                            <th class="p-2 text-sm font-medium text-gray-300">Lucro L√≠quido</th>
                            <th class="p-2 text-sm font-medium text-gray-300">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Se√ß√£o de Afiliados (Temporariamente Desabilitada) -->
        <div id="affiliateSection" class="bg-slate-900 p-6 rounded-xl shadow-2xl border border-slate-700 mb-6 hidden">
            <!-- Header Principal -->
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-100 mb-2">üí∞ Ganhe Dinheiro Indicando FLUXODRIVER</h2>
                <p class="text-lg text-green-400 font-semibold">R$ 13,46 por cada motorista que voc√™ indicar!</p>
            </div>

            <!-- Copy Persuasivo Atualizado -->
            <div class="bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 p-6 rounded-xl mb-6 border-2 border-slate-600">
                <h3 class="text-2xl font-bold text-slate-100 mb-4 text-center">üèÜ PROGRAMA DE AFILIADOS PREMIUM</h3>
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-amber-400 to-orange-500 text-slate-900 px-6 py-3 rounded-full inline-block font-bold text-xl shadow-lg">
                        45% DE COMISS√ÉO = R$ 13,46 POR VENDA
                    </div>
                    <p class="text-yellow-200 mt-2 font-medium">Saque m√≠nimo apenas R$ 10,00 ‚Ä¢ PIX instant√¢neo</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-gradient-to-br from-green-800 to-green-900 p-4 rounded-lg border border-green-600">
                        <h4 class="font-bold text-green-300 mb-3 text-center">üí∞ ALTA COMISS√ÉO</h4>
                        <div class="space-y-2 text-gray-200 text-center">
                            <p>‚úì 45% por cada venda</p>
                            <p>‚úì R$ 13,46 autom√°tico no PIX</p>
                            <p>‚úì Sem limites de ganhos</p>
                            <p>‚úì Saque a partir de R$ 10,00</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-800 to-blue-900 p-4 rounded-lg border border-blue-600">
                        <h4 class="font-bold text-blue-300 mb-3 text-center">üéØ F√ÅCIL DE VENDER</h4>
                        <div class="space-y-2 text-gray-200 text-center">
                            <p>‚úì Trial gr√°tis 48h</p>
                            <p>‚úì Pre√ßo baixo: R$ 29,90/90 dias</p>
                            <p>‚úì Produto espec√≠fico para motoristas</p>
                            <p>‚úì Alta taxa de convers√£o</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-800 to-purple-900 p-4 rounded-lg border border-purple-600">
                        <h4 class="font-bold text-purple-300 mb-3 text-center">‚ö° PAGAMENTO R√ÅPIDO</h4>
                        <div class="space-y-2 text-gray-200 text-center">
                            <p>‚úì PIX autom√°tico na hora</p>
                            <p>‚úì Sem burocracia ou espera</p>
                            <p>‚úì Comiss√£o garantida</p>
                            <p>‚úì Sistema 100% automatizado</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Como Funciona o Saque -->
            <div class="bg-slate-800 p-6 rounded-xl mb-6 border border-slate-600 shadow-lg">
                <h3 class="font-semibold text-slate-100 mb-4">üí∏ Como Funciona o Saque?</h3>
                <div class="space-y-4 text-sm text-slate-300">
                    <div class="flex items-start space-x-3">
                        <span class="bg-slate-600 text-slate-100 rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold">1</span>
                        <span>Configure sua chave PIX abaixo (CPF, celular, email ou chave aleat√≥ria)</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-slate-600 text-slate-100 rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold">2</span>
                        <span>Compartilhe seu link personalizado com outros motoristas</span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-slate-600 text-slate-100 rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold">3</span>
                        <span>Quando assinam usando seu link, voc√™ recebe <strong class="text-slate-100">R$ 13,46 automaticamente na sua conta</strong></span>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-green-700 text-green-100 rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold">‚úì</span>
                        <span class="text-green-400 font-semibold">Sem burocracia, sem espera - PIX instant√¢neo!</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">


                <!-- Earnings Panel -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-xl border border-slate-600 shadow-xl">
                    <h3 class="font-bold text-slate-100 mb-4 text-center">üí∞ Painel de Ganhos</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-700 p-3 rounded-lg border border-slate-600">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Seu C√≥digo:</span>
                                <span id="affiliateCodeDisplay" class="text-slate-100 font-mono font-bold">-</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-700 p-3 rounded-lg text-center border border-slate-600">
                                <div class="text-slate-400 text-xs">Dispon√≠vel</div>
                                <div id="totalEarnings" class="text-slate-100 font-bold text-xl">R$ 0,00</div>
                            </div>
                            <div class="bg-slate-700 p-3 rounded-lg text-center border border-slate-600">
                                <div class="text-slate-400 text-xs">Processando</div>
                                <div id="pendingEarnings" class="text-yellow-400 font-bold text-xl">R$ 0,00</div>
                            </div>
                        </div>
                        
                        <!-- Bot√£o de Saque -->
                        <button id="withdrawButton" onclick="showComingSoonMessage()" class="w-full bg-gradient-to-r from-slate-600 to-slate-700 text-slate-300 px-4 py-3 rounded-lg font-bold transition-all opacity-60 cursor-not-allowed shadow-lg">
                            üí∞ Em Breve - Sistema de Afiliados
                        </button>
                        <p class="text-xs text-slate-400 text-center">Saque instant√¢neo via PIX</p>
                    </div>
                </div>

                <!-- Configura√ß√µes PIX -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-xl border border-slate-600 shadow-xl">
                    <h3 class="font-bold text-slate-100 mb-4 text-center">üè¶ Configura√ß√£o PIX</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-300 mb-2 font-medium">Chave PIX para receber comiss√µes:</label>
                            <input type="text" id="withdrawalKey" class="w-full p-3 bg-slate-700 border border-slate-600 text-slate-100 rounded-lg focus:border-slate-500 focus:ring-2 focus:ring-slate-500 focus:ring-opacity-50 transition-all" placeholder="Digite: CPF, celular, email ou chave">
                            <p class="text-xs text-slate-400 mt-2">Ex: 11999887766 ou joao@email.com</p>
                        </div>
                        <button onclick="updateWithdrawalKey()" class="w-full bg-gradient-to-r from-slate-600 to-slate-700 text-slate-100 px-4 py-3 rounded-lg hover:from-slate-700 hover:to-slate-800 font-semibold transition-all transform hover:scale-105 shadow-lg">
                            üíæ Salvar Chave PIX
                        </button>
                        <button onclick="testPushinPayIntegration()" class="w-full bg-gradient-to-r from-amber-700 to-orange-800 text-amber-100 px-4 py-3 rounded-lg hover:from-amber-800 hover:to-orange-900 font-semibold transition-all transform hover:scale-105 shadow-lg">
                            üîß Testar Sistema de Pagamentos
                        </button>
                    </div>
                </div>

                <!-- Payment System Status -->
                <div id="paymentSystemStatus" class="bg-gradient-to-br from-gray-700 to-gray-800 p-5 rounded-xl border border-gray-600 hidden">
                    <h3 class="font-bold text-white mb-4 text-center">üîó Status Sistema de Pagamentos</h3>
                    <div id="paymentSystemInfo" class="space-y-3 text-sm">
                        <!-- Status info will be loaded here -->
                    </div>
                </div>



                <!-- Link de Indica√ß√£o -->
                <div class="md:col-span-2 bg-gradient-to-r from-green-800 to-blue-800 p-4 rounded-lg">
                    <h3 class="font-semibold text-white mb-3">üîó Seus Links de Afiliado</h3>
                    
                    <!-- Automatic Link -->
                    <div class="mb-3">
                        <label class="text-green-300 text-sm font-semibold">Link Autom√°tico:</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="affiliateLink" class="flex-1 p-2 bg-gray-900 border border-gray-600 text-white rounded-lg font-mono text-xs" readonly>
                            <button onclick="copyAffiliateLink()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                üìã Copiar
                            </button>
                        </div>
                    </div>

                    <!-- Custom Link -->
                    <div class="mb-3">
                        <label class="text-purple-300 text-sm font-semibold">Link Personalizado:</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="customLink" class="flex-1 p-2 bg-gray-900 border border-gray-600 text-white rounded-lg font-mono text-xs" readonly placeholder="Crie um link personalizado">
                            <button onclick="copyCustomLink()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                üìã Copiar
                            </button>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="customSlugInput" class="flex-1 p-2 bg-gray-800 border border-gray-500 text-white rounded-lg text-sm" placeholder="seu-nome-personalizado" maxlength="20">
                            <button onclick="showComingSoonMessage()" class="bg-slate-600 text-slate-300 px-4 py-2 rounded-lg opacity-60 cursor-not-allowed text-sm">
                                Em Breve
                            </button>
                        </div>
                        <p class="text-gray-400 text-xs mt-1">Apenas letras, n√∫meros e h√≠fens. Ex: joao-motorista</p>
                    </div>
                    <div class="text-center space-y-2">
                        <p class="text-green-300 font-semibold">üéØ Compartilhe onde tem motorista:</p>
                        <div class="flex flex-wrap justify-center gap-3 text-sm">
                            <span class="bg-green-600 px-3 py-1 rounded-full">WhatsApp</span>
                            <span class="bg-blue-600 px-3 py-1 rounded-full">Facebook</span>
                            <span class="bg-purple-600 px-3 py-1 rounded-full">Instagram</span>
                            <span class="bg-gray-600 px-3 py-1 rounded-full">Telegram</span>
                        </div>
                        <p class="text-yellow-300 text-sm">üí° Dica: Motoristas sempre procuram formas de aumentar ganhos!</p>
                    </div>
                </div>
            </div>

            <!-- Simulador de Ganhos Atualizado -->
            <div class="mt-6 bg-gradient-to-r from-green-900 to-emerald-900 p-6 rounded-lg border-2 border-green-500">
                <h3 class="font-bold text-white mb-4 text-center text-xl">üíé SIMULADOR DE GANHOS</h3>
                <div class="bg-black bg-opacity-50 p-4 rounded-lg mb-4">
                    <div class="text-center text-yellow-400 font-bold mb-2">CADA INDICA√á√ÉO = R$ 13,46</div>
                    <div class="text-center text-gray-300 text-sm">45% de comiss√£o ‚Ä¢ Saldo interno + Saque PIX manual</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg border border-green-600">
                        <h4 class="text-green-400 font-bold mb-3">METAS MENSAIS</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">5 indica√ß√µes/m√™s:</span>
                                <span class="text-green-400 font-bold">R$ 67,30</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">10 indica√ß√µes/m√™s:</span>
                                <span class="text-green-400 font-bold">R$ 134,60</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">20 indica√ß√µes/m√™s:</span>
                                <span class="text-yellow-400 font-bold">R$ 269,20</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">50 indica√ß√µes/m√™s:</span>
                                <span class="text-red-400 font-bold">R$ 673,00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-lg border border-yellow-600">
                        <h4 class="text-yellow-400 font-bold mb-3">POTENCIAL ANUAL</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">60 indica√ß√µes/ano:</span>
                                <span class="text-green-400 font-bold">R$ 807,60</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">120 indica√ß√µes/ano:</span>
                                <span class="text-yellow-400 font-bold">R$ 1.615,20</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">240 indica√ß√µes/ano:</span>
                                <span class="text-orange-400 font-bold">R$ 3.230,40</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">600 indica√ß√µes/ano:</span>
                                <span class="text-red-400 font-bold">R$ 8.076,00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <div class="bg-yellow-500 text-black px-6 py-2 rounded-full inline-block font-bold">
                        RENDA EXTRA GARANTIDA ‚Ä¢ SEM INVESTIMENTO INICIAL
                    </div>
                </div>
            </div>


        </div>

        <!-- Se√ß√£o de Registros (Mobile) -->
        <div id="recordsSection" class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Registros Salvos</h2>
            
            <!-- Lista de Registros Mobile -->
            <div>
                <div id="mobileRecordsList" class="space-y-3">
                    <!-- Records will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Relat√≥rios -->
        <div id="reportsSection" class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Relat√≥rios</h2>
            <div class="grid grid-cols-2 gap-4" id="reportsContent">
                <div class="bg-gray-700 p-3 rounded-lg text-center">
                    <div class="text-lg font-bold text-green-400" id="weeklyEarnings">R$ 0,00</div>
                    <div class="text-sm text-gray-300">Ganhos Semana</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg text-center">
                    <div class="text-lg font-bold text-blue-400" id="weeklyKm">0 km</div>
                    <div class="text-sm text-gray-300">KM Semana</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg text-center">
                    <div class="text-lg font-bold text-yellow-400" id="hourlyRate">R$ 0,00</div>
                    <div class="text-sm text-gray-300">R$/Hora</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg text-center">
                    <div class="text-lg font-bold text-purple-400" id="kmCost">R$ 0,00</div>
                    <div class="text-sm text-gray-300">Custo/KM</div>
                </div>
            </div>
            
            <!-- Se√ß√£o de Motiva√ß√£o -->
            <div class="mt-6 bg-gray-700 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-white font-semibold">Motiva√ß√£o do Dia</h3>
                    <button onclick="showRandomMotivationalMessage()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        Nova Frase
                    </button>
                </div>
                <p id="motivationalMessage" class="text-center text-gray-300 text-sm leading-relaxed min-h-[40px] flex items-center justify-center">
                    ‚ú® Carregando inspira√ß√£o...
                </p>
            </div>
        </div>

        <!-- Se√ß√£o de Multas -->
        <div id="finesSection" class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Multas</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="mobile_fine_type" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Tipo da multa">
                    <input type="number" id="mobile_fine_amount" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Valor (R$)" step="0.01">
                </div>
                <input type="text" id="mobile_fine_location" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Local da multa">
                <button onclick="addMobileFine()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-semibold">
                    Adicionar Multa
                </button>
            </div>
            <div id="mobileFinsList" class="mt-4 space-y-2">
                <!-- Fines will be loaded here -->
            </div>
        </div>

        <!-- Se√ß√£o de Manuten√ß√£o -->
        <div id="maintenanceSection" class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Manuten√ß√£o</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="mobile_maintenance_type" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Tipo">
                    <input type="number" id="mobile_maintenance_cost" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Custo (R$)" step="0.01">
                </div>
                <textarea id="mobile_maintenance_description" class="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg" placeholder="Descri√ß√£o" rows="3"></textarea>
                <button onclick="addMobileMaintenance()" class="w-full bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700 font-semibold">
                    Adicionar Manuten√ß√£o
                </button>
            </div>
            <div id="mobileMaintenanceList" class="mt-4 space-y-2">
                <!-- Maintenance will be loaded here -->
            </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√µes -->
        <div id="settingsSection" class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Configura√ß√µes</h2>
            
            <!-- Notifica√ß√µes -->
            <div class="space-y-4">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-white font-semibold mb-3">Notifica√ß√µes</h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Lembretes di√°rios</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enableNotifications" class="sr-only peer" onchange="toggleNotifications()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div id="notificationSettings" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Hor√°rio do lembrete</label>
                                <input type="time" id="reminderTime" value="20:00" class="w-full p-2 bg-gray-600 border border-gray-500 text-white rounded-lg" onchange="updateReminderTime()">
                            </div>
                            
                            <button onclick="testNotification()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                Testar Notifica√ß√£o
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes de Contato -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-white font-semibold mb-3">Informa√ß√µes de Contato</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">WhatsApp</label>
                            <input type="tel" id="userWhatsApp" class="w-full p-2 bg-gray-600 border border-gray-500 text-white rounded-lg" placeholder="N√£o configurado">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Instagram</label>
                            <input type="text" id="userInstagram" class="w-full p-2 bg-gray-600 border border-gray-500 text-white rounded-lg" placeholder="N√£o configurado">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Facebook</label>
                            <input type="text" id="userFacebook" class="w-full p-2 bg-gray-600 border border-gray-500 text-white rounded-lg" placeholder="N√£o configurado">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Telegram</label>
                            <input type="text" id="userTelegram" class="w-full p-2 bg-gray-600 border border-gray-500 text-white rounded-lg" placeholder="N√£o configurado">
                        </div>
                        
                        <button onclick="saveContactInfo()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                            Salvar Informa√ß√µes
                        </button>
                    </div>
                </div>

                <!-- Dados e Backup -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-white font-semibold mb-3">Dados</h3>
                    
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                            Exportar Dados (CSV)
                        </button>
                        
                        <button onclick="clearOfflineData()" class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 text-sm">
                            Limpar Cache Offline
                        </button>
                    </div>
                </div>

                <!-- Testes do Sistema -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-white font-semibold mb-3">Testes do Sistema</h3>
                    
                    <div class="space-y-3">
                        <button onclick="testExpireTrial()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                            Teste 1: Expirar Trial
                        </button>
                        
                        <button onclick="testResetTrial()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                            Teste 2: Resetar Trial 48h
                        </button>
                        
                        <button onclick="testPushinPayFlow()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                            Teste 3: Fluxo PushinPay
                        </button>
                        
                        <div id="testResults" class="bg-gray-800 p-3 rounded text-xs text-gray-300 hidden">
                            <div class="font-semibold mb-2">Resultados dos Testes:</div>
                            <div id="testOutput"></div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes do App -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-white font-semibold mb-3">Sobre o App</h3>
                    
                    <div class="space-y-2 text-sm text-gray-300">
                        <div class="flex justify-between">
                            <span>Vers√£o:</span>
                            <span>2.0.0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>√öltima atualiza√ß√£o:</span>
                            <span id="lastUpdate">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Status:</span>
                            <span id="connectionStatus" class="text-green-400">Online</span>
                        </div>
                    </div>
                    
                    <button onclick="checkForUpdates()" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 text-sm mt-3">
                        Verificar Atualiza√ß√µes
                    </button>
                </div>

                <!-- Instala√ß√£o PWA -->
                <div id="installPrompt" class="bg-gray-700 p-4 rounded-lg hidden">
                    <h3 class="text-white font-semibold mb-3">Instalar App</h3>
                    <p class="text-gray-300 text-sm mb-3">Instale o FLUXODRIVER na tela inicial para acesso mais r√°pido</p>
                    <button onclick="installPWA()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                        Instalar App
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let records = [];
        let notificationPermission = false;

        // API base URL
        const API_BASE = '/api';

        // PWA and Notification Features
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                    checkNotificationPermission();
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
        }

        // Check and request notification permission
        async function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                    scheduleReminders();
                } else if (Notification.permission === 'default') {
                    showNotificationPrompt();
                }
            }
        }

        // Show notification permission prompt
        function showNotificationPrompt() {
            const promptDiv = document.createElement('div');
            promptDiv.className = 'fixed top-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50';
            promptDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold">Ativar Lembretes</h4>
                        <p class="text-sm">Receba notifica√ß√µes para registrar seus ganhos di√°rios</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="requestNotificationPermission()" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-semibold">Ativar</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-white opacity-75 text-sm">Agora n√£o</button>
                    </div>
                </div>
            `;
            document.body.appendChild(promptDiv);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (promptDiv.parentElement) {
                    promptDiv.remove();
                }
            }, 10000);
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
                
                if (notificationPermission) {
                    scheduleReminders();
                    showSuccessMessage('Notifica√ß√µes ativadas! Voc√™ receber√° lembretes di√°rios.');
                } else {
                    showErrorMessage('Notifica√ß√µes negadas. Voc√™ pode ativ√°-las nas configura√ß√µes do navegador.');
                }
                
                // Remove prompt
                const prompt = document.querySelector('.fixed.top-4');
                if (prompt) prompt.remove();
                
                return notificationPermission;
            }
            return false;
        }

        // Show notification
        function showNotification(title, body, options = {}) {
            if (notificationPermission && 'serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification(title, {
                        body: body,
                        icon: '/icon-192x192.png',
                        badge: '/icon-192x192.png',
                        vibrate: [200, 100, 200],
                        data: { url: '/' },
                        actions: [
                            {
                                action: 'open',
                                title: 'Registrar Ganhos',
                                icon: '/icon-192x192.png'
                            }
                        ],
                        requireInteraction: true,
                        tag: 'reminder',
                        ...options
                    });
                });
            }
        }

        // Schedule daily reminders
        function scheduleReminders() {
            const reminderSettings = JSON.parse(localStorage.getItem('reminderSettings') || '{"enabled": true, "time": "20:00"}');
            
            if (!reminderSettings.enabled) return;

            if (window.reminderInterval) {
                clearInterval(window.reminderInterval);
            }

            const [hours, minutes] = reminderSettings.time.split(':');
            const now = new Date();
            const reminderTime = new Date();
            reminderTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            if (reminderTime <= now) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }

            const timeUntilReminder = reminderTime.getTime() - now.getTime();

            setTimeout(() => {
                sendSmartNotification();

                window.reminderInterval = setInterval(() => {
                    sendSmartNotification();
                }, 24 * 60 * 60 * 1000);
            }, timeUntilReminder);
        }

        // Intelligent notification system based on performance
        async function sendSmartNotification() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const records = await response.json();
                    const analysis = analyzePerformance(records);
                    const notification = generateSmartNotification(analysis);
                    
                    showNotification(notification.title, notification.message, {
                        requireInteraction: true,
                        tag: 'smart-reminder',
                        actions: [
                            {
                                action: 'register',
                                title: 'Registrar Ganhos',
                                icon: '/icon-192x192.png'
                            },
                            {
                                action: 'improve',
                                title: 'Ver Dicas',
                                icon: '/icon-192x192.png'
                            }
                        ]
                    });
                } else {
                    showNotification(
                        'FLUXODRIVER - Lembrete',
                        'Hora de registrar seus ganhos de hoje!',
                        { tag: 'daily-reminder' }
                    );
                }
            } catch (error) {
                showNotification(
                    'FLUXODRIVER - Lembrete',
                    'Hora de registrar seus ganhos de hoje!',
                    { tag: 'daily-reminder' }
                );
            }
        }

        // Analyze driver performance and trends
        function analyzePerformance(records) {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            const thisWeek = records.filter(r => new Date(r.createdAt || r.date) >= oneWeekAgo);
            const lastWeek = records.filter(r => {
                const date = new Date(r.createdAt || r.date);
                return date >= twoWeeksAgo && date < oneWeekAgo;
            });
            const yesterdayRecords = records.filter(r => {
                const date = new Date(r.createdAt || r.date);
                return date.toDateString() === yesterday.toDateString();
            });

            const thisWeekEarnings = thisWeek.reduce((sum, r) => sum + ((parseFloat(r.gross) || 0) + (parseFloat(r.uber_earnings) || 0) + (parseFloat(r.tips) || 0)), 0);
            const lastWeekEarnings = lastWeek.reduce((sum, r) => sum + ((parseFloat(r.gross) || 0) + (parseFloat(r.uber_earnings) || 0) + (parseFloat(r.tips) || 0)), 0);
            const thisWeekKm = thisWeek.reduce((sum, r) => sum + (parseFloat(r.km) || 0), 0);
            const thisWeekHours = thisWeek.reduce((sum, r) => sum + (parseFloat(r.hours_worked) || 0), 0);
            const thisWeekExpenses = thisWeek.reduce((sum, r) => sum + ((parseFloat(r.fuel) || 0) + (parseFloat(r.food) || 0)), 0);

            const earningsChange = lastWeekEarnings > 0 ? ((thisWeekEarnings - lastWeekEarnings) / lastWeekEarnings) * 100 : 0;
            const hourlyRate = thisWeekHours > 0 ? thisWeekEarnings / thisWeekHours : 0;
            const kmCost = thisWeekKm > 0 ? thisWeekExpenses / thisWeekKm : 0;
            const profitMargin = thisWeekEarnings > 0 ? ((thisWeekEarnings - thisWeekExpenses) / thisWeekEarnings) * 100 : 0;

            return {
                thisWeekEarnings,
                earningsChange,
                hourlyRate,
                kmCost,
                profitMargin,
                recordsThisWeek: thisWeek.length,
                workedYesterday: yesterdayRecords.length > 0,
                averageKmPerDay: thisWeek.length > 0 ? thisWeekKm / thisWeek.length : 0
            };
        }

        // Generate smart notification based on performance analysis
        function generateSmartNotification(analysis) {
            const { thisWeekEarnings, earningsChange, hourlyRate, profitMargin, recordsThisWeek, workedYesterday, averageKmPerDay } = analysis;

            // No records this week
            if (recordsThisWeek === 0) {
                return {
                    title: 'FLUXODRIVER - Vamos Come√ßar!',
                    message: 'Ainda n√£o h√° registros esta semana. Que tal come√ßar hoje e aumentar seus ganhos?'
                };
            }

            // Didn't work yesterday
            if (!workedYesterday) {
                return {
                    title: 'FLUXODRIVER - Oportunidade Perdida',
                    message: 'Voc√™ n√£o trabalhou ontem. Cada dia √© uma chance de aumentar seus ganhos!'
                };
            }

            // Earnings declining
            if (earningsChange < -10) {
                return {
                    title: 'FLUXODRIVER - Hora de Acelerar!',
                    message: `Seus ganhos ca√≠ram ${Math.abs(earningsChange).toFixed(1)}% esta semana. Vamos recuperar e superar!`
                };
            }

            // Low hourly rate
            if (hourlyRate < 15) {
                return {
                    title: 'FLUXODRIVER - Otimize seus Ganhos',
                    message: `Sua m√©dia √© R$ ${hourlyRate.toFixed(2)}/hora. Dica: trabalhe nos hor√°rios de pico para ganhar mais!`
                };
            }

            // Low profit margin
            if (profitMargin < 60) {
                return {
                    title: 'FLUXODRIVER - Reduza Custos',
                    message: `Sua margem de lucro est√° em ${profitMargin.toFixed(1)}%. Revise seus gastos com combust√≠vel e alimenta√ß√£o!`
                };
            }

            // Low daily km average
            if (averageKmPerDay < 50) {
                return {
                    title: 'FLUXODRIVER - Aumente a Dist√¢ncia',
                    message: `M√©dia de ${averageKmPerDay.toFixed(0)} km/dia. Que tal aceitar corridas mais longas hoje?`
                };
            }

            // Good performance
            if (earningsChange > 5) {
                return {
                    title: 'FLUXODRIVER - Parab√©ns!',
                    message: `Seus ganhos subiram ${earningsChange.toFixed(1)}%! Continue assim e registre os ganhos de hoje!`
                };
            }

            // Default motivational
            return {
                title: 'FLUXODRIVER - Continue Firme!',
                message: `Ganhos da semana: R$ ${thisWeekEarnings.toFixed(2)}. Vamos registrar mais um dia de sucesso!`
            };
        }

        // Show success message
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 left-4 right-4 bg-green-600 text-white p-3 rounded-lg shadow-lg z-50';
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // Show error message
        function showErrorMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 left-4 right-4 bg-red-600 text-white p-3 rounded-lg shadow-lg z-50';
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Page navigation functions
        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            clearLoginForm();
        }

        function showRegister() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
        }

        function showMain() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            // Show records section by default on desktop
            if (window.innerWidth >= 1024) {
                // Desktop view - show all sections
                return;
            } else {
                // Mobile view - show records section by default
                showMobileSection('records');
            }
        }

        // Affiliate Cookie System (10 days)
        function setAffiliateCookie(affiliateCode) {
            const expirationDays = 10;
            const expirationDate = new Date();
            expirationDate.setTime(expirationDate.getTime() + (expirationDays * 24 * 60 * 60 * 1000));
            
            document.cookie = `affiliate_ref=${affiliateCode}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Lax`;
            localStorage.setItem('affiliate_ref', affiliateCode);
            localStorage.setItem('affiliate_ref_expires', expirationDate.getTime().toString());
            
            console.log(`Affiliate cookie set for ${affiliateCode} - expires in 10 days`);
        }

        function getAffiliateCookie() {
            // Check localStorage first (more reliable)
            const storedRef = localStorage.getItem('affiliate_ref');
            const storedExpiry = localStorage.getItem('affiliate_ref_expires');
            
            if (storedRef && storedExpiry) {
                const expiryTime = parseInt(storedExpiry);
                if (new Date().getTime() < expiryTime) {
                    return storedRef;
                } else {
                    // Cookie expired, clean up
                    clearAffiliateCookie();
                    return null;
                }
            }
            
            // Fallback to document.cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'affiliate_ref') {
                    return value;
                }
            }
            
            return null;
        }

        function clearAffiliateCookie() {
            document.cookie = 'affiliate_ref=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            localStorage.removeItem('affiliate_ref');
            localStorage.removeItem('affiliate_ref_expires');
        }

        // Check for affiliate referral on page load
        function checkAffiliateReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode) {
                setAffiliateCookie(refCode);
                // Clean URL without refreshing page
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                showAlert(`Voc√™ ser√° creditado ao afiliado ${refCode} por 10 dias!`);
            }
        }

        // Authentication functions
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorElement, 'Preencha todos os campos.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    
                    if (data.hasAccess) {
                        showMain();
                        await loadRecords();
                        calculateWeeklySummary();
                        
                        // Show trial info if available
                        if (data.trialInfo && !data.isPaid) {
                            showSuccess(document.getElementById('mainMessage'), 
                                `Trial ativo! ${data.trialInfo.hoursLeft} horas restantes.`);
                        }
                    } else {
                        showError(errorElement, data.message);
                    }
                } else {
                    showError(errorElement, data.message);
                }
            } catch (error) {
                showError(errorElement, 'Erro de conex√£o. Tente novamente.');
            }
        }

        async function register() {
            const username = document.getElementById('newUsername').value;
            const phone = document.getElementById('newPhone').value;
            const password = document.getElementById('newPassword').value;
            let affiliateCode = document.getElementById('affiliateCode').value.trim();
            const errorElement = document.getElementById('registerError');

            // Check for affiliate cookie if no code is manually entered
            if (!affiliateCode) {
                const cookieRef = getAffiliateCookie();
                if (cookieRef) {
                    affiliateCode = cookieRef;
                    console.log(`Using affiliate code from 10-day cookie: ${affiliateCode}`);
                }
            }

            if (!username || !phone || !password) {
                showError(errorElement, 'Preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Validate phone format
            const phoneRegex = /^[0-9]{10,15}$/;
            if (!phoneRegex.test(phone)) {
                showError(errorElement, 'Telefone deve conter apenas n√∫meros (10-15 d√≠gitos).');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, phone, password, affiliateCode })
                });

                const data = await response.json();

                if (response.ok) {
                    // Clear affiliate cookie after successful registration
                    if (affiliateCode) {
                        clearAffiliateCookie();
                    }
                    alert(data.message);
                    clearRegisterForm();
                    showLogin();
                } else {
                    showError(errorElement, data.message);
                }
            } catch (error) {
                showError(errorElement, 'Erro de conex√£o. Tente novamente.');
            }
        }

        async function subscribe() {
            if (!authToken) {
                alert('Fa√ßa login primeiro.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/create-subscription`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    window.open(data.subscriptionLink, '_blank');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Erro ao criar assinatura. Tente novamente.');
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showLogin();
            clearForm();
        }

        // Record management functions
        let isSubmitting = false;
        let lastSubmissionTime = 0;
        
        async function addRecord() {
            const now = Date.now();
            
            // Prevent rapid submissions (minimum 2 seconds between submissions)
            if (now - lastSubmissionTime < 2000) {
                console.log('‚ö†Ô∏è Tentativa muito r√°pida, ignorando...');
                return;
            }
            
            // Prevent multiple submissions
            if (isSubmitting) {
                console.log('‚ö†Ô∏è Submiss√£o j√° em andamento, ignorando...');
                return;
            }
            
            const addBtn = document.getElementById('addRecordBtn');
            if (!addBtn || addBtn.disabled) {
                console.log('‚ö†Ô∏è Bot√£o n√£o dispon√≠vel ou j√° desabilitado...');
                return;
            }
            
            // Set flags immediately
            isSubmitting = true;
            lastSubmissionTime = now;
            
            // Disable button and show loading state
            const originalText = addBtn.textContent;
            addBtn.disabled = true;
            addBtn.textContent = 'Salvando...';
            addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            

            
            try {
                const km = parseFloat(document.getElementById('km').value) || 0;
                const hours_worked = parseFloat(document.getElementById('hours_worked').value) || 0;
                const gross = parseFloat(document.getElementById('gross').value) || 0;
                const uber_earnings = parseFloat(document.getElementById('uber_earnings').value) || 0;
                const tips = parseFloat(document.getElementById('tips').value) || 0;
                const fuel = parseFloat(document.getElementById('fuel').value) || 0;
                const food = parseFloat(document.getElementById('food').value) || 0;
                const insurance = parseFloat(document.getElementById('insurance').value) || 0;
                const other = parseFloat(document.getElementById('other').value) || 0;

                if (km <= 0 || hours_worked <= 0) {
                    showAlert('Quil√¥metros rodados e horas trabalhadas s√£o obrigat√≥rios.');
                    // Reset flags on validation error
                    isSubmitting = false;
                    addBtn.disabled = false;
                    addBtn.textContent = originalText;
                    addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                if (!authToken) {
                    showAlert('Erro de autentica√ß√£o. Fa√ßa login novamente.');
                    // Reset flags on auth error
                    isSubmitting = false;
                    addBtn.disabled = false;
                    addBtn.textContent = originalText;
                    addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }

                const totalEarnings = gross + uber_earnings + tips;
                const totalExpenses = fuel + food + insurance + other;
                const net = totalEarnings - totalExpenses;

                const recordData = {
                    km,
                    hours_worked,
                    gross,
                    uber_earnings,
                    tips,
                    fuel,
                    food,
                    insurance,
                    other,
                    net
                };

                const response = await fetch(`${API_BASE}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });

                if (response.ok) {
                    clearForm();
                    showAlert('Registro adicionado com sucesso!');
                    await loadRecords();
                    calculateWeeklySummary();
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Erro ao salvar registro');
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                showAlert('Erro de conex√£o. Verifique sua internet e tente novamente.');
            } finally {
                // Re-enable button after a safe delay
                setTimeout(() => {
                    isSubmitting = false;
                    if (addBtn) {
                        addBtn.disabled = false;
                        addBtn.textContent = originalText;
                        addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }, 1500);
            }
        }

        async function loadRecords() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    records = await response.json();
                    displayRecords();
                } else {
                    records = [];
                }
            } catch (error) {
                console.error('Erro ao carregar registros:', error);
                console.error('Token atual:', authToken);
                console.error('URL completa:', `${API_BASE}/records`);
                records = [];
            }
        }

        async function deleteRecord(recordId) {
            if (!confirm('Tem certeza que deseja excluir este registro?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/records/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    await loadRecords();
                    calculateWeeklySummary();
                    alert('Registro exclu√≠do com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message);
                }
            } catch (error) {
                alert('Erro ao excluir registro. Tente novamente.');
            }
        }

        // Display functions
        function displayRecords() {
            const tableBody = document.getElementById('recordsTable');
            tableBody.innerHTML = '';

            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Nenhum registro encontrado</td></tr>';
                return;
            }

            records.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-700';
                
                const totalEarnings = parseFloat(record.gross || 0) + parseFloat(record.uber_earnings || 0) + parseFloat(record.tips || 0);
                const totalExpenses = parseFloat(record.fuel) + parseFloat(record.food) + parseFloat(record.insurance) + parseFloat(record.other);
                
                row.innerHTML = `
                    <td class="p-2">${formatDate(record.date)}</td>
                    <td class="p-2">${parseFloat(record.km).toFixed(1)} km</td>
                    <td class="p-2">R$ ${totalEarnings.toFixed(2)}</td>
                    <td class="p-2">R$ ${totalExpenses.toFixed(2)}</td>
                    <td class="p-2 ${parseFloat(record.net) >= 0 ? 'text-green-600' : 'text-red-600'}">R$ ${parseFloat(record.net).toFixed(2)}</td>
                    <td class="p-2">
                        <button onclick="deleteRecord('${record.id}')" class="text-red-600 hover:text-red-800 text-sm">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function calculateWeeklySummary() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const currentWeekRecords = records.filter(record => new Date(record.date) >= oneWeekAgo);
            const previousWeekStart = new Date(oneWeekAgo);
            previousWeekStart.setDate(previousWeekStart.getDate() - 7);
            const previousWeekRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= previousWeekStart && recordDate < oneWeekAgo;
            });

            // Current week calculations
            const weeklyKm = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.km), 0);
            const weeklyHours = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.hours_worked || 0), 0);
            const weeklyGross = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.gross || 0) + parseFloat(record.uber_earnings || 0) + parseFloat(record.tips || 0), 0);
            const weeklyNet = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.net), 0);
            const weeklyFuel = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.fuel || 0), 0);
            const weeklyExpenses = currentWeekRecords.reduce((sum, record) => sum + parseFloat(record.fuel || 0) + parseFloat(record.food || 0) + parseFloat(record.insurance || 0) + parseFloat(record.other || 0), 0);

            // Advanced calculations
            const costPerKm = weeklyKm > 0 ? weeklyExpenses / weeklyKm : 0;
            const earningsPerHour = weeklyHours > 0 ? weeklyGross / weeklyHours : 0;
            const efficiency = weeklyFuel > 0 ? weeklyKm / (weeklyFuel / 5.5) : 0; // Assuming 5.5 R$/liter average

            // Previous week calculations
            const previousWeekNet = previousWeekRecords.reduce((sum, record) => sum + parseFloat(record.net), 0);

            // Calculate percentage change
            let weekPercentage = 0;
            if (previousWeekNet > 0) {
                weekPercentage = ((weeklyNet - previousWeekNet) / previousWeekNet) * 100;
            } else if (weeklyNet > 0) {
                weekPercentage = 100;
            }

            // Update display
            document.getElementById('weeklyKm').textContent = `${weeklyKm.toFixed(1)} km`;
            document.getElementById('weeklyGross').textContent = `R$ ${weeklyGross.toFixed(2)}`;
            document.getElementById('weeklyNet').textContent = `R$ ${weeklyNet.toFixed(2)}`;
            
            const percentageElement = document.getElementById('weekPercentage');
            percentageElement.textContent = `${weekPercentage.toFixed(1)}%`;
            percentageElement.className = `text-lg font-bold ${weekPercentage >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // Update advanced metrics
            document.getElementById('weeklyCostPerKm').textContent = `R$ ${costPerKm.toFixed(2)}`;
            document.getElementById('weeklyEarningsPerHour').textContent = `R$ ${earningsPerHour.toFixed(2)}`;
            document.getElementById('weeklyEfficiency').textContent = `${efficiency.toFixed(1)}`;
            document.getElementById('weeklyHours').textContent = `${weeklyHours.toFixed(1)}h`;

            // Generate weekly ranking and monthly comparison
            generateWeeklyRanking();
            calculateMonthlyComparison();

            // Motivational message
            updateMotivationalMessage(weeklyNet, weekPercentage);
        }

        // Biblioteca completa de frases motivacionais para motoristas (100+ frases)
        const motivationalMessages = [
            "Cada quil√¥metro √© um passo rumo ao seu sucesso!",
            "Voc√™ est√° no controle da sua jornada. Continue firme!",
            "Todo dia √© uma nova chance de brilhar na estrada!",
            "Seu esfor√ßo hoje pavimenta o caminho para amanh√£!",
            "Acelere com confian√ßa, voc√™ est√° no caminho certo!",
            "Cada corrida conta, cada ganho soma!",
            "Voc√™ √© mais forte que qualquer desafio na estrada!",
            "Mantenha o foco, seus lucros est√£o acelerando!",
            "A estrada √© longa, mas voc√™ √© impar√°vel!",
            "Todo KM vale, todo esfor√ßo recompensa!",
            "Voc√™ transforma cada corrida em oportunidade!",
            "Dirija com prop√≥sito, o sucesso est√° logo adiante!",
            "Seus ganhos refletem sua dedica√ß√£o. Continue assim!",
            "A jornada √© sua, e voc√™ est√° dominando o volante!",
            "Cada dia na estrada √© um novo recorde pessoal!",
            "Voc√™ est√° construindo seu futuro, KM por KM!",
            "Mantenha o ritmo, voc√™ est√° indo longe!",
            "Seu trabalho duro est√° tra√ßando o caminho do sucesso!",
            "A estrada pode ser longa, mas voc√™ √© mais forte!",
            "Cada ganho √© uma vit√≥ria, celebre suas conquistas!",
            "Voc√™ √© o motorista do seu pr√≥prio destino!",
            "Continue acelerando, o sucesso est√° na pr√≥xima curva!",
            "Sua determina√ß√£o transforma quil√¥metros em lucros!",
            "Todo esfor√ßo conta, voc√™ est√° no caminho certo!",
            "Dirija com paix√£o, os resultados vir√£o!",
            "Voc√™ est√° pavimentando o caminho para grandes vit√≥rias!",
            "Cada corrida √© um passo rumo aos seus objetivos!",
            "Mantenha a energia alta, voc√™ est√° brilhando!",
            "A estrada √© sua, conquiste-a com confian√ßa!",
            "Seu trabalho √°rduo est√° rendendo frutos. Continue!",
            "Voc√™ √© o mestre da sua jornada, acelere!",
            "Cada KM rodado √© uma hist√≥ria de sucesso!",
            "A determina√ß√£o move voc√™ mais longe que qualquer carro!",
            "Voc√™ est√° transformando esfor√ßo em resultados!",
            "Mantenha o volante firme, o sucesso est√° pr√≥ximo!",
            "Cada ganho √© um motivo para se orgulhar!",
            "Voc√™ est√° no comando, dirija rumo aos seus sonhos!",
            "A estrada pode desafiar, mas voc√™ √© imbat√≠vel!",
            "Seu esfor√ßo hoje √© o lucro de amanh√£!",
            "Continue na pista, voc√™ est√° indo incr√≠vel!",
            "Cada corrida √© uma chance de crescer ainda mais!",
            "Voc√™ est√° tra√ßando seu caminho para o topo!",
            "Mantenha o foco, seus lucros est√£o acelerando!",
            "A jornada √© longa, mas voc√™ √© incans√°vel!",
            "Voc√™ transforma cada KM em oportunidade!",
            "Dirija com confian√ßa, o sucesso √© seu destino!",
            "Seu trabalho duro √© o combust√≠vel do seu sucesso!",
            "Cada ganho √© um passo rumo aos seus sonhos!",
            "Voc√™ est√° no controle, mantenha o ritmo!",
            "A estrada √© desafiadora, mas voc√™ √© mais forte!",
            "Continue acelerando, voc√™ est√° no caminho certo!",
            "Cada KM rodado √© um marco de sua dedica√ß√£o!",
            "Voc√™ √© o motorista da sua pr√≥pria hist√≥ria de sucesso!",
            "Mantenha a energia, os lucros est√£o chegando!",
            "Seu esfor√ßo √© a chave para abrir novas portas!",
            "Dirija com prop√≥sito, voc√™ est√° indo longe!",
            "Cada corrida √© uma vit√≥ria, celebre seu progresso!",
            "Voc√™ est√° pavimentando o caminho para o sucesso!",
            "Mantenha o volante firme, voc√™ √© impar√°vel!",
            "Seu trabalho √°rduo est√° transformando sua jornada!",
            "Cada ganho √© uma prova da sua determina√ß√£o!",
            "Voc√™ est√° no comando da sua estrada para o sucesso!",
            "Continue na pista, os resultados est√£o vindo!",
            "A jornada pode ser longa, mas voc√™ √© incans√°vel!",
            "Cada KM √© uma chance de brilhar ainda mais!",
            "Voc√™ transforma desafios em oportunidades!",
            "Dirija com confian√ßa, voc√™ est√° no caminho certo!",
            "Seu esfor√ßo √© o motor do seu sucesso!",
            "Cada dia √© uma nova largada para a vit√≥ria!",
            "Voc√™ est√° escrevendo sua hist√≥ria de sucesso na estrada!",
            "Mantenha a acelera√ß√£o, seus objetivos est√£o pr√≥ximos!",
            "A persist√™ncia √© seu combust√≠vel para o sucesso!",
            "Cada passageiro √© uma oportunidade de crescer!",
            "Voc√™ est√° construindo um imp√©rio sobre rodas!",
            "Sua dedica√ß√£o √© o GPS para o sucesso!",
            "Continue dirigindo, voc√™ est√° mudando sua vida!",
            "Cada quil√¥metro rodado √© um investimento no futuro!",
            "Voc√™ tem o poder de transformar sua jornada!",
            "Mantenha o foco na meta, voc√™ est√° chegando l√°!",
            "A estrada ensina, mas voc√™ √© quem aprende e vence!",
            "Seu volante, suas regras, seu sucesso!",
            "Cada corrida bem-sucedida √© uma li√ß√£o de vida!",
            "Voc√™ est√° dirigindo em dire√ß√£o aos seus sonhos!",
            "Mantenha a velocidade constante rumo ao topo!",
            "Sua determina√ß√£o n√£o conhece sem√°foros!",
            "Cada passageiro satisfeito √© uma estrela na sua avalia√ß√£o!",
            "Voc√™ est√° no fast lane para o sucesso!",
            "Continue acelerando, o destino √© pr√≥spero!",
            "Sua jornada profissional n√£o tem limite de velocidade!",
            "Cada dia na estrada √© um dia mais pr√≥ximo da independ√™ncia!",
            "Voc√™ √© o CEO da sua pr√≥pria empresa sobre rodas!",
            "Mantenha o tanque cheio de motiva√ß√£o e determina√ß√£o!",
            "Sua carteira de motorista √© tamb√©m uma licen√ßa para sonhar!",
            "Cada corrida √© um passo rumo √† liberdade financeira!",
            "Voc√™ est√° construindo seu patrim√¥nio quil√¥metro a quil√¥metro!",
            "Continue na estrada, o sucesso est√° na pr√≥xima esquina!",
            "Seu GPS interior sempre aponta para o sucesso!",
            "Cada madrugada trabalhada √© um investimento no futuro!",
            "Voc√™ transformou seu carro em uma m√°quina de realizar sonhos!",
            "Mantenha as m√£os no volante e os olhos no pr√™mio!",
            "Sua hist√≥ria de sucesso est√° sendo escrita em cada viagem!",
            "Continue firme, voc√™ est√° mudando o jogo da sua vida!",
            "Cada real ganho √© uma vit√≥ria conquistada com suor!",
            "Voc√™ est√° construindo sua aposentadoria sobre quatro rodas!",
            "Mantenha a marcha engrenada rumo ao crescimento!",
            "Cada avalia√ß√£o 5 estrelas √© um trof√©u na sua carreira!",
            "Voc√™ est√° dirigindo sua vida na dire√ß√£o certa!",
            "Continue acelerando, a linha de chegada est√° pr√≥xima!",
            "Seu trabalho hoje √© o conforto de amanh√£!",
            "Voc√™ est√° transformando combust√≠vel em conquistas!",
            "Mantenha a dire√ß√£o firme, voc√™ √© o piloto da sua vida!",
            "Cada viagem √© uma nova p√°gina na sua hist√≥ria de sucesso!",
            "Voc√™ est√° construindo um legado sobre rodas!",
            "Continue dirigindo, voc√™ est√° no caminho da prosperidade!",
            "Seu esfor√ßo √© o combust√≠vel que move seus sonhos!",
            "Cada corrida √© uma prova de que voc√™ n√£o desiste!",
            "Voc√™ est√° navegando pelas ruas do sucesso!",
            "Mantenha o ritmo, voc√™ est√° ganhando a corrida da vida!",
            "Sua persist√™ncia est√° abrindo todas as portas!"
        ];

        function updateMotivationalMessage(weeklyNet, weekPercentage) {
            const messageElement = document.getElementById('motivationalMessage');
            let message = '';

            if (weeklyNet > 0 && weekPercentage > 0) {
                // Mensagens de sucesso crescente
                const successMessages = [
                    "Excelente! Voc√™ est√° no caminho certo. Continue assim!",
                    "Incr√≠vel! Seus lucros est√£o crescendo semana a semana!",
                    "Fant√°stico! Voc√™ est√° dominando a estrada do sucesso!",
                    "Perfeito! Sua dedica√ß√£o est√° dando frutos!"
                ];
                const randomSuccess = motivationalMessages.filter((msg, index) => index % 4 === 0);
                const combined = [...successMessages, ...randomSuccess.slice(0, 10)];
                message = 'üöÄ ' + combined[Math.floor(Math.random() * combined.length)];
            } else if (weeklyNet > 0 && weekPercentage < 0) {
                // Mensagens de melhoria
                const improvementMessages = [
                    "Bons ganhos esta semana. Vamos melhorar ainda mais!",
                    "Voc√™ est√° ganhando! Agora √© hora de acelerar!",
                    "Resultado positivo! Continue ajustando a rota!",
                    "Lucro garantido! Vamos otimizar ainda mais!"
                ];
                const randomImprovement = motivationalMessages.filter((msg, index) => index % 4 === 1);
                const combined = [...improvementMessages, ...randomImprovement.slice(0, 10)];
                message = 'üìà ' + combined[Math.floor(Math.random() * combined.length)];
            } else if (weeklyNet <= 0) {
                // Mensagens de supera√ß√£o
                const challengeMessages = [
                    "Toda jornada tem desafios. Analise seus gastos e otimize!",
                    "Momentos dif√≠ceis geram motoristas mais fortes!",
                    "Esta √© sua chance de mostrar sua determina√ß√£o!",
                    "Grandes vit√≥rias v√™m ap√≥s grandes desafios!"
                ];
                const randomChallenge = motivationalMessages.filter((msg, index) => index % 4 === 2);
                const combined = [...challengeMessages, ...randomChallenge.slice(0, 10)];
                message = 'üí™ ' + combined[Math.floor(Math.random() * combined.length)];
            } else {
                // Mensagem motivacional geral
                message = '‚≠ê ' + motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            }

            if (messageElement) {
                messageElement.textContent = message;
            }
        }

        // Fun√ß√£o para exibir mensagem motivacional aleat√≥ria
        function showRandomMotivationalMessage() {
            const messageElement = document.getElementById('motivationalMessage');
            if (messageElement) {
                const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                messageElement.textContent = '‚ú® ' + randomMessage;
                
                // Animar a mensagem
                messageElement.style.transform = 'scale(1.05)';
                messageElement.style.transition = 'transform 0.3s ease';
                setTimeout(() => {
                    messageElement.style.transform = 'scale(1)';
                }, 300);
            }
        }

        function generateWeeklyRanking() {
            const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const dayData = {};

            // Initialize days
            dayNames.forEach(day => {
                dayData[day] = { earnings: 0, count: 0 };
            });

            // Calculate earnings by day of week
            records.forEach(record => {
                const date = new Date(record.date);
                const dayName = dayNames[date.getDay()];
                const earnings = parseFloat(record.gross || 0) + parseFloat(record.uber_earnings || 0) + parseFloat(record.tips || 0);
                
                dayData[dayName].earnings += earnings;
                dayData[dayName].count++;
            });

            // Sort days by average earnings
            const sortedDays = Object.entries(dayData)
                .map(([day, data]) => ({
                    day,
                    avgEarnings: data.count > 0 ? data.earnings / data.count : 0,
                    totalCount: data.count
                }))
                .sort((a, b) => b.avgEarnings - a.avgEarnings);

            // Display ranking
            const rankingElement = document.getElementById('weeklyRanking');
            rankingElement.innerHTML = '';

            sortedDays.forEach((dayInfo, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìä';
                const rankItem = document.createElement('div');
                rankItem.className = 'flex justify-between items-center p-2 bg-gray-700 rounded';
                rankItem.innerHTML = `
                    <span class="text-white">${medal} ${dayInfo.day}</span>
                    <span class="text-green-400">R$ ${dayInfo.avgEarnings.toFixed(2)} (${dayInfo.totalCount} dias)</span>
                `;
                rankingElement.appendChild(rankItem);
            });
        }

        function calculateMonthlyComparison() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Current month records
            const currentMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
            });

            // Previous month records
            const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const previousMonthRecords = records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getMonth() === previousMonth && recordDate.getFullYear() === previousYear;
            });

            // Calculate totals
            const currentMonthNet = currentMonthRecords.reduce((sum, record) => sum + parseFloat(record.net), 0);
            const previousMonthNet = previousMonthRecords.reduce((sum, record) => sum + parseFloat(record.net), 0);

            // Calculate variation
            let monthlyVariation = 0;
            if (previousMonthNet > 0) {
                monthlyVariation = ((currentMonthNet - previousMonthNet) / previousMonthNet) * 100;
            } else if (currentMonthNet > 0) {
                monthlyVariation = 100;
            }

            // Update display
            document.getElementById('currentMonthNet').textContent = `R$ ${currentMonthNet.toFixed(2)}`;
            document.getElementById('previousMonthNet').textContent = `R$ ${previousMonthNet.toFixed(2)}`;
            
            const variationElement = document.getElementById('monthlyVariation');
            variationElement.textContent = `${monthlyVariation > 0 ? '+' : ''}${monthlyVariation.toFixed(1)}%`;
            variationElement.className = `text-xl font-bold ${monthlyVariation >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }

        // Utility functions
        // Maintenance and Fines functions
        async function addMaintenance() {
            const type = document.getElementById('maintenance_type').value;
            const cost = parseFloat(document.getElementById('maintenance_cost').value) || 0;
            const notes = document.getElementById('maintenance_notes').value;

            if (!type || cost <= 0) {
                alert('Tipo e custo s√£o obrigat√≥rios.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, cost, notes })
                });

                if (response.ok) {
                    clearMaintenanceForm();
                    alert('Manuten√ß√£o adicionada com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message);
                }
            } catch (error) {
                alert('Erro ao adicionar manuten√ß√£o. Tente novamente.');
            }
        }

        async function addFine() {
            const type = document.getElementById('fine_type').value;
            const amount = parseFloat(document.getElementById('fine_amount').value) || 0;
            const location = document.getElementById('fine_location').value;
            const status = document.getElementById('fine_status').value;

            if (!type || amount <= 0) {
                alert('Tipo e valor s√£o obrigat√≥rios.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/fines`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, amount, location, status })
                });

                if (response.ok) {
                    clearFineForm();
                    alert('Multa adicionada com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message);
                }
            } catch (error) {
                alert('Erro ao adicionar multa. Tente novamente.');
            }
        }

        function clearForm() {
            document.getElementById('km').value = '';
            document.getElementById('hours_worked').value = '';
            document.getElementById('gross').value = '';
            document.getElementById('uber_earnings').value = '';
            document.getElementById('tips').value = '';
            document.getElementById('fuel').value = '';
            document.getElementById('food').value = '';
            document.getElementById('insurance').value = '';
            document.getElementById('other').value = '';
        }

        function clearMaintenanceForm() {
            document.getElementById('maintenance_type').value = '';
            document.getElementById('maintenance_cost').value = '';
            document.getElementById('maintenance_notes').value = '';
        }

        function clearFineForm() {
            document.getElementById('fine_type').value = '';
            document.getElementById('fine_amount').value = '';
            document.getElementById('fine_location').value = '';
            document.getElementById('fine_status').value = 'Pendente';
        }

        function clearRegisterForm() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('affiliateCode').value = '';
            document.getElementById('registerError').classList.add('hidden');
        }

        function clearLoginForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Initialize app
        function initApp() {
            if (authToken) {
                // Try to check subscription status and load data
                fetch(`${API_BASE}/check-subscription`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Token invalid');
                })
                .then(data => {
                    if (data.hasAccess) {
                        showMain();
                        loadRecords().then(() => calculateWeeklySummary());
                        
                        // Show trial info if available
                        if (data.trialInfo && !data.isPaid) {
                            showSuccess(document.getElementById('mainMessage'), 
                                `Trial ativo! ${data.trialInfo.hoursLeft} horas restantes.`);
                        }
                    } else {
                        showLogin();
                    }
                })
                .catch(() => {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    showLogin();
                });
            } else {
                showLogin();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Load affiliate data function
        async function loadAffiliateData() {
            try {
                await loadAffiliateStats();
                await loadNetworkData();
                await loadBadges();
            } catch (error) {
                console.error('Error loading affiliate data:', error);
            }
        }

        // Load contact info on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadContactInfo();
            }, 500);
        });

        // PushinPay subscription for 48h trial testing
        async function subscribePushinPay() {
            if (!authToken) {
                showAlert('Fa√ßa login primeiro.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/create-pushinpay-subscription`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    window.open(data.paymentLink, '_blank');
                } else {
                    showAlert(data.message || 'Erro ao processar pagamento');
                }
            } catch (error) {
                showAlert('Erro de conex√£o. Tente novamente.');
            }
        }

        // Show coming soon message for affiliate features
        function showComingSoonMessage() {
            showAlert('Funcionalidade em desenvolvimento. Sistema de afiliados estar√° dispon√≠vel em breve!');
        }

        // Save contact information
        function saveContactInfo() {
            const whatsapp = document.getElementById('userWhatsApp').value;
            const instagram = document.getElementById('userInstagram').value;
            const facebook = document.getElementById('userFacebook').value;
            const telegram = document.getElementById('userTelegram').value;

            // Save to localStorage for now
            localStorage.setItem('userContactInfo', JSON.stringify({
                whatsapp,
                instagram,
                facebook,
                telegram
            }));

            showAlert('Informa√ß√µes de contato salvas com sucesso!');
        }

        // Load contact information
        function loadContactInfo() {
            const savedInfo = localStorage.getItem('userContactInfo');
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('userWhatsApp').value = info.whatsapp || '';
                document.getElementById('userInstagram').value = info.instagram || '';
                document.getElementById('userFacebook').value = info.facebook || '';
                document.getElementById('userTelegram').value = info.telegram || '';
            }
        }

        // Test 1: Expire trial for testing
        async function testExpireTrial() {
            if (!authToken) {
                showAlert('Fa√ßa login primeiro.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/test-expire-trial`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                showTestResult('Teste 1', data.message, response.ok);
                
                if (response.ok) {
                    // Force reload to see changes
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                showTestResult('Teste 1', 'Erro de conex√£o: ' + error.message, false);
            }
        }

        // Test 2: Reset trial to 48 hours
        async function testResetTrial() {
            if (!authToken) {
                showAlert('Fa√ßa login primeiro.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/test-reset-trial`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                showTestResult('Teste 2', data.message, response.ok);
                
                if (response.ok) {
                    // Force reload to see changes
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                showTestResult('Teste 2', 'Erro de conex√£o: ' + error.message, false);
            }
        }

        // Test 3: PushinPay flow
        async function testPushinPayFlow() {
            if (!authToken) {
                showAlert('Fa√ßa login primeiro.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/create-pushinpay-subscription`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showTestResult('Teste 3', 'Link de pagamento criado com sucesso', true);
                    showAlert('Link de pagamento PushinPay criado! Verifique os resultados do teste.');
                } else {
                    showTestResult('Teste 3', data.message, false);
                }
            } catch (error) {
                showTestResult('Teste 3', 'Erro de conex√£o: ' + error.message, false);
            }
        }

        // Show test results
        function showTestResult(testName, message, success) {
            const resultsDiv = document.getElementById('testResults');
            const outputDiv = document.getElementById('testOutput');
            
            const timestamp = new Date().toLocaleTimeString();
            const status = success ? '‚úÖ' : '‚ùå';
            const color = success ? 'text-green-400' : 'text-red-400';
            
            outputDiv.innerHTML += `
                <div class="${color} mb-1">
                    ${status} ${testName} (${timestamp}): ${message}
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
        }

        // Test payment system integration
        async function testPushinPayIntegration() {
            try {
                const response = await fetch(`${API_BASE}/test-pushinpay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: 29.90 })
                });

                const data = await response.json();
                const statusDiv = document.getElementById('paymentSystemStatus');
                const infoDiv = document.getElementById('paymentSystemInfo');

                if (data.success) {
                    infoDiv.innerHTML = `
                        <div class="text-green-400 font-semibold">‚úÖ PushinPay Sistema Ativo</div>
                        <div class="text-gray-300">Status: ${data.message}</div>
                        <div class="text-gray-300">Valor de teste: R$ ${data.amount}</div>
                        <div class="text-gray-300">Payment ID: ${data.paymentId}</div>
                        <div class="text-blue-400">Sistema principal configurado</div>
                        <div class="text-yellow-400">Teste de 48h funcional</div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="text-red-400 font-semibold">‚ùå Erro na Conex√£o</div>
                        <div class="text-gray-300">Status: ${data.message}</div>
                        <div class="text-gray-300">C√≥digo: ${response.status}</div>
                        <div class="text-gray-300">Detalhes: ${data.error || 'Erro desconhecido'}</div>
                    `;
                }

                statusDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error testing payment system:', error);
                const statusDiv = document.getElementById('paymentSystemStatus');
                const infoDiv = document.getElementById('paymentSystemInfo');
                
                infoDiv.innerHTML = `
                    <div class="text-red-400 font-semibold">‚ùå Erro na Conex√£o</div>
                    <div class="text-gray-300">Status: Erro na conex√£o</div>
                    <div class="text-gray-300">Detalhes: ${error.message}</div>
                `;
                
                statusDiv.classList.remove('hidden');
            }
        }

        // Custom affiliate link functions
        function copyCustomLink() {
            const linkField = document.getElementById('customLink');
            if (!linkField || !linkField.value) {
                showAlert('Primeiro crie um link personalizado!');
                return;
            }
            linkField.select();
            linkField.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showAlert('Link personalizado copiado!');
        }

        async function createCustomLink() {
            const customSlug = document.getElementById('customSlugInput').value.trim().toLowerCase();
            
            if (!customSlug) {
                showAlert('Digite um nome para seu link personalizado.');
                return;
            }

            if (!/^[a-zA-Z0-9-]+$/.test(customSlug)) {
                showAlert('Use apenas letras, n√∫meros e h√≠fens.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/affiliate/custom-link`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customSlug })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('customLink').value = data.customLink;
                    document.getElementById('customSlugInput').value = '';
                    showAlert('Link personalizado criado com sucesso!');
                } else {
                    showAlert(data.message || 'Erro ao criar link personalizado.');
                }
            } catch (error) {
                showAlert('Erro de conex√£o. Tente novamente.');
            }
        }

        async function shareWhatsApp() {
            try {
                const response = await fetch(`${API_BASE}/affiliate/sharing-links`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.open(data.links.whatsapp, '_blank');
                } else {
                    showAlert('Erro ao gerar link de compartilhamento.');
                }
            } catch (error) {
                showAlert('Erro de conex√£o.');
            }
        }

        async function shareTelegram() {
            try {
                const response = await fetch(`${API_BASE}/affiliate/sharing-links`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.open(data.links.telegram, '_blank');
                } else {
                    showAlert('Erro ao gerar link de compartilhamento.');
                }
            } catch (error) {
                showAlert('Erro de conex√£o.');
            }
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkAffiliateReferral();
            checkDeviceTrialStatus();
            initApp();
        });

        // Handle Enter key in login forms
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (!document.getElementById('loginPage').classList.contains('hidden')) {
                    login();
                } else if (!document.getElementById('registerPage').classList.contains('hidden')) {
                    register();
                }
            }
        });

        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'üì± Instalar App';
            installBtn.className = 'fixed top-4 right-4 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm z-50 touch-target';
            installBtn.onclick = installApp;
            document.body.appendChild(installBtn);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        console.log('PWA instalado');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Mobile navigation functions
        function showMobileSection(section) {
            const sections = ['records', 'reports', 'fines', 'maintenance', 'affiliate'];
            sections.forEach(s => {
                const element = document.getElementById(s + 'Section');
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            const targetSection = document.getElementById(section + 'Section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
                
                // Load affiliate data when section is shown
                if (section === 'affiliate') {
                    loadAffiliateStats();
                    setTimeout(() => initializeNetworkVisualization(), 100);
                }
            }
        }

        // Affiliate functions
        async function loadAffiliateStats() {
            try {
                const response = await fetch(`${API_BASE}/affiliate/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('affiliateCodeDisplay').textContent = data.affiliateCode || 'N√£o gerado';
                    document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
                    document.getElementById('totalEarnings').textContent = `R$ ${(data.totalEarnings || 0).toFixed(2)}`;
                    document.getElementById('pendingEarnings').textContent = `R$ ${(data.pendingEarnings || 0).toFixed(2)}`;
                    document.getElementById('withdrawalKey').value = data.withdrawalKey || '';
                    document.getElementById('affiliateLink').value = data.affiliateLink || '';
                    document.getElementById('customLink').value = data.customLink || '';
                    
                    // Update withdraw button status
                    updateWithdrawButtonStatus(data.totalEarnings || 0, data.withdrawalKey);
                } else {
                    console.log('Perfil de afiliado n√£o encontrado - ser√° criado automaticamente');
                }
            } catch (error) {
                console.error('Erro ao carregar dados de afiliado:', error);
            }
        }

        function updateWithdrawButtonStatus(totalEarnings, withdrawalKey) {
            const withdrawButton = document.getElementById('withdrawButton');
            const MIN_WITHDRAWAL = 5.00;
            
            if (withdrawButton) {
                const canWithdraw = totalEarnings >= MIN_WITHDRAWAL && withdrawalKey;
                withdrawButton.disabled = !canWithdraw;
                
                if (!withdrawalKey) {
                    withdrawButton.textContent = 'üîí Configure PIX primeiro';
                } else if (totalEarnings < MIN_WITHDRAWAL) {
                    withdrawButton.textContent = `üí∞ Sacar PIX (Min. R$ ${MIN_WITHDRAWAL.toFixed(2)})`;
                } else {
                    withdrawButton.textContent = `üí∞ Sacar R$ ${totalEarnings.toFixed(2)} via PIX`;
                    withdrawButton.classList.add('animate-pulse');
                }
            }
        }

        async function requestWithdrawal() {
            if (!confirm('Confirma o saque via PIX? O valor ser√° enviado instantaneamente para sua chave configurada.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/affiliate/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ${data.message}`);
                    loadAffiliateStats(); // Reload data
                } else {
                    showAlert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                showAlert('‚ùå Erro ao processar saque. Tente novamente.');
            }
        }

        async function updateWithdrawalKey() {
            const withdrawalKey = document.getElementById('withdrawalKey').value.trim();
            
            if (!withdrawalKey) {
                showAlert('Por favor, insira uma chave PIX v√°lida.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/affiliate/withdrawal-key`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ withdrawalKey })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ${data.message}`);
                    loadAffiliateStats(); // Reload data to update button status
                } else {
                    showAlert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                showAlert('‚ùå Erro ao salvar chave PIX. Tente novamente.');
            }
        }

        function copyAffiliateLink() {
            const linkField = document.getElementById('affiliateLink');
            linkField.select();
            linkField.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(linkField.value);
            alert('Link copiado para a √°rea de transfer√™ncia!');
        }

        // Mobile-specific functions
        async function addMobileRecord() {
            const km = document.getElementById('mobile_km').value;
            const hours = document.getElementById('mobile_hours').value;
            const gross = document.getElementById('mobile_gross').value || 0;
            const uber = document.getElementById('mobile_uber').value || 0;
            const tips = document.getElementById('mobile_tips').value || 0;
            const fuel = document.getElementById('mobile_fuel').value || 0;
            const food = document.getElementById('mobile_food').value || 0;

            if (!km || !hours) {
                alert('Preencha KM e Horas trabalhadas');
                return;
            }

            const recordData = {
                km: parseFloat(km),
                hours_worked: parseFloat(hours),
                gross: parseFloat(gross),
                uber_earnings: parseFloat(uber),
                tips: parseFloat(tips),
                fuel: parseFloat(fuel),
                food: parseFloat(food),
                insurance: 0,
                other: 0
            };

            try {
                const response = await fetch(`${API_BASE}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(recordData)
                });

                if (response.ok) {
                    clearMobileRecordForm();
                    loadMobileRecords();
                    updateMobileReports();
                    alert('Registro salvo com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message || 'Erro ao salvar registro');
                }
            } catch (error) {
                alert('Erro de conex√£o. Tente novamente.');
            }
        }

        async function addMobileFine() {
            const type = document.getElementById('mobile_fine_type').value;
            const amount = document.getElementById('mobile_fine_amount').value;
            const location = document.getElementById('mobile_fine_location').value;

            if (!type || !amount) {
                alert('Preencha tipo e valor da multa');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/fines`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        amount: parseFloat(amount),
                        location
                    })
                });

                if (response.ok) {
                    clearMobileFineForm();
                    loadMobileFines();
                    alert('Multa adicionada com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message || 'Erro ao adicionar multa');
                }
            } catch (error) {
                alert('Erro de conex√£o. Tente novamente.');
            }
        }

        async function addMobileMaintenance() {
            const type = document.getElementById('mobile_maintenance_type').value;
            const cost = document.getElementById('mobile_maintenance_cost').value;
            const description = document.getElementById('mobile_maintenance_description').value;

            if (!type || !cost) {
                alert('Preencha tipo e custo da manuten√ß√£o');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        cost: parseFloat(cost),
                        description
                    })
                });

                if (response.ok) {
                    clearMobileMaintenanceForm();
                    loadMobileMaintenance();
                    alert('Manuten√ß√£o adicionada com sucesso!');
                } else {
                    const data = await response.json();
                    alert(data.message || 'Erro ao adicionar manuten√ß√£o');
                }
            } catch (error) {
                alert('Erro de conex√£o. Tente novamente.');
            }
        }

        function clearMobileRecordForm() {
            document.getElementById('mobile_km').value = '';
            document.getElementById('mobile_hours').value = '';
            document.getElementById('mobile_gross').value = '';
            document.getElementById('mobile_uber').value = '';
            document.getElementById('mobile_tips').value = '';
            document.getElementById('mobile_fuel').value = '';
            document.getElementById('mobile_food').value = '';
        }

        function clearMobileFineForm() {
            document.getElementById('mobile_fine_type').value = '';
            document.getElementById('mobile_fine_amount').value = '';
            document.getElementById('mobile_fine_location').value = '';
        }

        function clearMobileMaintenanceForm() {
            document.getElementById('mobile_maintenance_type').value = '';
            document.getElementById('mobile_maintenance_cost').value = '';
            document.getElementById('mobile_maintenance_description').value = '';
        }

        async function loadMobileRecords() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMobileRecords(data.slice(0, 5)); // Show last 5 records
                }
            } catch (error) {
                console.error('Erro ao carregar registros:', error);
            }
        }

        async function loadMobileFines() {
            try {
                const response = await fetch(`${API_BASE}/fines`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMobileFines(data);
                }
            } catch (error) {
                console.error('Erro ao carregar multas:', error);
            }
        }

        async function loadMobileMaintenance() {
            try {
                const response = await fetch(`${API_BASE}/maintenance`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMobileMaintenance(data);
                }
            } catch (error) {
                console.error('Erro ao carregar manuten√ß√£o:', error);
            }
        }

        function displayMobileRecords(records) {
            const container = document.getElementById('mobileRecordsList');
            container.innerHTML = '';

            if (records.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum registro encontrado</p>';
                return;
            }

            records.forEach(record => {
                const totalEarnings = (parseFloat(record.gross) || 0) + (parseFloat(record.uber_earnings) || 0) + (parseFloat(record.tips) || 0);
                const totalExpenses = (parseFloat(record.fuel) || 0) + (parseFloat(record.food) || 0);
                const net = totalEarnings - totalExpenses;

                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-white font-semibold">${formatDate(record.date)}</div>
                            <div class="text-gray-300 text-sm">${record.km} km ‚Ä¢ ${record.hours_worked}h</div>
                        </div>
                        <div class="text-right">
                            <div class="text-green-400 font-bold">R$ ${totalEarnings.toFixed(2)}</div>
                            <div class="text-gray-400 text-sm">Lucro: R$ ${net.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function displayMobileFines(fines) {
            const container = document.getElementById('mobileFinsList');
            container.innerHTML = '';

            if (fines.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma multa registrada</p>';
                return;
            }

            fines.forEach(fine => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-white font-semibold">${fine.type}</div>
                            <div class="text-gray-300 text-sm">${fine.location || 'Local n√£o informado'}</div>
                        </div>
                        <div class="text-red-400 font-bold">R$ ${parseFloat(fine.amount).toFixed(2)}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function displayMobileMaintenance(maintenance) {
            const container = document.getElementById('mobileMaintenanceList');
            container.innerHTML = '';

            if (maintenance.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma manuten√ß√£o registrada</p>';
                return;
            }

            maintenance.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-white font-semibold">${item.type}</div>
                            <div class="text-gray-300 text-sm">${item.description || 'Sem descri√ß√£o'}</div>
                        </div>
                        <div class="text-orange-400 font-bold">R$ ${parseFloat(item.cost).toFixed(2)}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function updateMobileReports() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                    
                    const weeklyRecords = records.filter(record => new Date(record.createdAt || record.date) >= oneWeekAgo);
                    
                    const weeklyKm = weeklyRecords.reduce((sum, record) => sum + parseFloat(record.km || 0), 0);
                    const weeklyHours = weeklyRecords.reduce((sum, record) => sum + parseFloat(record.hours_worked || 0), 0);
                    const weeklyEarnings = weeklyRecords.reduce((sum, record) => {
                        return sum + (parseFloat(record.gross || 0) + parseFloat(record.uber_earnings || 0) + parseFloat(record.tips || 0));
                    }, 0);
                    const weeklyExpenses = weeklyRecords.reduce((sum, record) => {
                        return sum + (parseFloat(record.fuel || 0) + parseFloat(record.food || 0));
                    }, 0);
                    
                    const hourlyRate = weeklyHours > 0 ? weeklyEarnings / weeklyHours : 0;
                    const kmCost = weeklyKm > 0 ? weeklyExpenses / weeklyKm : 0;
                    
                    const weeklyEarningsEl = document.getElementById('weeklyEarnings');
                    const weeklyKmEl = document.getElementById('weeklyKm');
                    const hourlyRateEl = document.getElementById('hourlyRate');
                    const kmCostEl = document.getElementById('kmCost');
                    
                    if (weeklyEarningsEl) weeklyEarningsEl.textContent = `R$ ${weeklyEarnings.toFixed(2)}`;
                    if (weeklyKmEl) weeklyKmEl.textContent = `${weeklyKm.toFixed(1)} km`;
                    if (hourlyRateEl) hourlyRateEl.textContent = `R$ ${hourlyRate.toFixed(2)}`;
                    if (kmCostEl) kmCostEl.textContent = `R$ ${kmCost.toFixed(2)}`;
                }
                
            } catch (error) {
                console.error('Erro ao atualizar relat√≥rios:', error);
            }
        }

        function showMobileSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('#recordsSection, #reportsSection, #finesSection, #maintenanceSection, #affiliateSection, #settingsSection');
            sections.forEach(section => {
                if (section) section.classList.add('hidden');
            });

            // Show selected section
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.remove('hidden');
            }

            // Update navigation - remove active from all first
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked button
            document.querySelectorAll(`[onclick*="${sectionName}"]`).forEach(item => {
                if (item.closest('.mobile-nav-item')) {
                    item.closest('.mobile-nav-item').classList.add('active');
                } else {
                    item.classList.add('active');
                }
            });

            // Load section-specific data
            if (authToken) {
                switch(sectionName) {
                    case 'records':
                        loadMobileRecords();
                        break;
                    case 'reports':
                        updateMobileReports();
                        showRandomMotivationalMessage();
                        break;
                    case 'fines':
                        loadMobileFines();
                        break;
                    case 'maintenance':
                        loadMobileMaintenance();
                        break;
                    case 'affiliate':
                        loadAffiliateData();
                        break;
                    case 'settings':
                        loadSettingsData();
                        break;
                }
            }
        }

        // Configuration functions
        function toggleNotifications() {
            const checkbox = document.getElementById('enableNotifications');
            const settings = document.getElementById('notificationSettings');
            
            if (checkbox.checked) {
                requestNotificationPermission();
                settings.style.display = 'block';
            } else {
                notificationPermission = false;
                settings.style.display = 'none';
                if (window.reminderInterval) {
                    clearInterval(window.reminderInterval);
                }
            }
            
            // Save preference
            localStorage.setItem('notificationsEnabled', checkbox.checked);
        }

        function updateReminderTime() {
            const time = document.getElementById('reminderTime').value;
            const reminderSettings = {
                enabled: true,
                time: time
            };
            localStorage.setItem('reminderSettings', JSON.stringify(reminderSettings));
            
            if (notificationPermission) {
                scheduleReminders();
            }
        }

        function testNotification() {
            if (notificationPermission) {
                showNotification(
                    'FLUXODRIVER - Teste',
                    'Esta √© uma notifica√ß√£o de teste. Funcionando perfeitamente!',
                    { tag: 'test' }
                );
            } else {
                requestNotificationPermission().then(granted => {
                    if (granted) {
                        showNotification(
                            'FLUXODRIVER - Teste',
                            'Notifica√ß√µes ativadas! Esta √© uma notifica√ß√£o de teste.',
                            { tag: 'test' }
                        );
                    }
                });
            }
        }

        async function exportData() {
            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const records = await response.json();
                    const csv = generateCSV(records);
                    downloadCSV(csv, 'fluxodriver-dados.csv');
                    showSuccessMessage('Dados exportados com sucesso!');
                }
            } catch (error) {
                showErrorMessage('Erro ao exportar dados');
            }
        }

        function generateCSV(records) {
            const headers = ['Data', 'KM', 'Horas', 'Ganhos 99', 'Ganhos Uber', 'Outros Ganhos', 'Gasolina', 'Comida', 'Lucro L√≠quido'];
            const rows = records.map(record => [
                formatDate(record.createdAt || record.date),
                record.km,
                record.hours_worked,
                record.gross || 0,
                record.uber_earnings || 0,
                record.tips || 0,
                record.fuel || 0,
                record.food || 0,
                record.net || 0
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function clearOfflineData() {
            if (confirm('Tem certeza que deseja limpar todos os dados offline?')) {
                try {
                    await caches.delete('fluxodriver-v2');
                    localStorage.removeItem('reminderSettings');
                    showSuccessMessage('Cache offline limpo com sucesso!');
                } catch (error) {
                    showErrorMessage('Erro ao limpar cache offline');
                }
            }
        }

        function checkForUpdates() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ action: 'checkUpdate' });
                showSuccessMessage('Verificando atualiza√ß√µes...');
            }
        }

        function loadSettingsData() {
            // Load notification settings
            const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const reminderSettings = JSON.parse(localStorage.getItem('reminderSettings') || '{"enabled": true, "time": "20:00"}');
            
            document.getElementById('enableNotifications').checked = notificationsEnabled && notificationPermission;
            document.getElementById('reminderTime').value = reminderSettings.time;
            document.getElementById('notificationSettings').style.display = notificationsEnabled ? 'block' : 'none';
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Check connection status
            updateConnectionStatus();
            
            // Show install prompt if available
            if (window.deferredPrompt) {
                document.getElementById('installPrompt').classList.remove('hidden');
            }
        }

        function updateConnectionStatus() {
            const status = navigator.onLine ? 'Online' : 'Offline';
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = navigator.onLine ? 'text-green-400' : 'text-red-400';
        }

        // PWA Installation
        window.deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt) {
                installPrompt.classList.remove('hidden');
            }
        });

        function installPWA() {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showSuccessMessage('App instalado com sucesso!');
                        const installPrompt = document.getElementById('installPrompt');
                        if (installPrompt) {
                            installPrompt.classList.add('hidden');
                        }
                    }
                    window.deferredPrompt = null;
                });
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Service Worker message handler
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.action === 'navigate' && event.data.section) {
                    showMobileSection(event.data.section);
                }
            });
        }

        // Trial Timer Functions
        let trialTimerInterval;
        
        function startTrialTimer() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            if (!userData.trialStartDate) {
                userData.trialStartDate = new Date().toISOString();
                localStorage.setItem('userData', JSON.stringify(userData));
            }

            function updateTimer() {
                const trialStart = new Date(userData.trialStartDate);
                const now = new Date();
                const trialEnd = new Date(trialStart.getTime() + (48 * 60 * 60 * 1000)); // 48 hours
                const timeLeft = trialEnd - now;

                const timeRemainingEl = document.getElementById('timeRemaining');
                const trialTimerEl = document.getElementById('trialTimer');
                const activateBtn = document.getElementById('activateNowBtn');

                if (!timeRemainingEl) return;

                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    timeRemainingEl.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Show notification when trial is about to expire (last 2 hours)
                    if (timeLeft <= (2 * 60 * 60 * 1000) && !userData.notificationShown) {
                        showTrialExpirationNotification();
                        userData.notificationShown = true;
                        localStorage.setItem('userData', JSON.stringify(userData));
                    }
                } else {
                    timeRemainingEl.textContent = 'EXPIRADO';
                    if (trialTimerEl) {
                        trialTimerEl.classList.remove('from-emerald-600', 'to-blue-600');
                        trialTimerEl.classList.add('from-red-600', 'to-red-700');
                    }
                    if (activateBtn) {
                        activateBtn.textContent = 'ATIVAR CONTA';
                    }
                    showTrialExpiredNotification();
                    clearInterval(trialTimerInterval);
                }
            }

            updateTimer();
            trialTimerInterval = setInterval(updateTimer, 1000);
        }

        function showTrialExpirationNotification() {
            if (Notification.permission === 'granted') {
                new Notification('FLUXODRIVER - Trial expira em breve!', {
                    body: 'Seu trial de 48h expira em menos de 2 horas. Ative agora por apenas R$ 29,90!',
                    icon: '/favicon.ico'
                });
            }
        }

        function showTrialExpiredNotification() {
            if (Notification.permission === 'granted') {
                new Notification('FLUXODRIVER - Trial expirado!', {
                    body: 'Seu trial de 48h expirou. Ative agora por apenas R$ 29,90 para continuar usando!',
                    icon: '/favicon.ico'
                });
            }
        }

        // Enhanced mobile interface initialization
        function showMobileInterface() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mobileContainer').style.display = 'block';
            
            // Show first section by default
            showMobileSection('records');
            
            // Set first nav item as active
            const firstNavItem = document.querySelector('.mobile-nav-item');
            if (firstNavItem) {
                firstNavItem.classList.add('active');
            }

            // Start trial timer
            setTimeout(() => startTrialTimer(), 500);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Activate now button event
            const activateBtn = document.getElementById('activateNowBtn');
            if (activateBtn) {
                activateBtn.addEventListener('click', function() {
                    showSection('payment');
                });
            }

            // Start onboarding for new users
            setTimeout(() => startOnboarding(), 1000);
        }

        // Onboarding System
        let currentOnboardingStep = 0;
        const onboardingSteps = [
            {
                target: '#recordsNavBtn',
                title: 'üìä Registros Di√°rios',
                content: 'Aqui voc√™ adiciona seus ganhos e gastos de cada dia. √â o cora√ß√£o do FLUXODRIVER - registre quilometragem, ganhos do Uber, combust√≠vel e alimenta√ß√£o.',
                position: 'top'
            },
            {
                target: '#mobile_km',
                title: 'üöó Quilometragem',
                content: 'Registre quantos KM voc√™ rodou no dia. Isso ajuda a calcular o custo por quil√¥metro e otimizar suas rotas.',
                position: 'bottom',
                action: () => showMobileSection('records')
            },
            {
                target: '#mobile_uber_earnings',
                title: 'üí∞ Ganhos do Uber',
                content: 'Digite quanto voc√™ ganhou no Uber neste dia. O sistema calcula automaticamente seus lucros e m√©tricas de performance.',
                position: 'bottom'
            },
            {
                target: '#reportsNavBtn',
                title: 'üìà Relat√≥rios Inteligentes',
                content: 'Veja relat√≥rios detalhados dos seus ganhos, an√°lise semanal e dicas personalizadas para aumentar sua renda.',
                position: 'top',
                action: () => showMobileSection('reports')
            },
            {
                target: '#affiliateNavBtn',
                title: 'ü§ù Programa de Afiliados',
                content: 'Ganhe R$ 13,46 por cada motorista que voc√™ indicar! Configure sua chave PIX e comece a ganhar renda extra.',
                position: 'top',
                action: () => showMobileSection('affiliate')
            },
            {
                target: '#settingsNavBtn',
                title: '‚öôÔ∏è Configura√ß√µes',
                content: 'Personalize o app, ative notifica√ß√µes e configure suas prefer√™ncias. Pronto! Agora voc√™ domina o FLUXODRIVER.',
                position: 'top',
                action: () => showMobileSection('settings')
            }
        ];

        function startOnboarding() {
            // Check if user has already seen onboarding
            if (localStorage.getItem('fluxodriverOnboardingCompleted')) {
                return;
            }

            currentOnboardingStep = 0;
            document.getElementById('totalSteps').textContent = onboardingSteps.length;
            document.getElementById('onboardingOverlay').style.display = 'block';
            showOnboardingStep();
        }

        function showOnboardingStep() {
            const step = onboardingSteps[currentOnboardingStep];
            
            // Execute step action if exists
            if (step.action) {
                step.action();
            }

            // Update progress
            document.getElementById('currentStep').textContent = currentOnboardingStep + 1;
            
            // Update tooltip content
            document.getElementById('tooltipTitle').textContent = step.title;
            document.getElementById('tooltipContent').textContent = step.content;

            // Show/hide navigation buttons
            const prevBtn = document.getElementById('onboardingPrev');
            const nextBtn = document.getElementById('onboardingNext');
            
            prevBtn.style.display = currentOnboardingStep > 0 ? 'block' : 'none';
            nextBtn.textContent = currentOnboardingStep === onboardingSteps.length - 1 ? 'Finalizar' : 'Pr√≥ximo';

            // Position tooltip
            setTimeout(() => positionTooltip(step.target, step.position), 100);
            
            // Highlight target element
            highlightElement(step.target);
        }

        function positionTooltip(targetSelector, position) {
            const target = document.querySelector(targetSelector);
            const tooltip = document.getElementById('onboardingTooltip');
            
            if (!target || !tooltip) return;

            // Remove previous position classes
            tooltip.className = 'onboarding-tooltip';
            
            const targetRect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let top, left;

            switch(position) {
                case 'top':
                    top = targetRect.top - tooltipRect.height - 20;
                    left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
                    tooltip.classList.add('bottom');
                    break;
                case 'bottom':
                    top = targetRect.bottom + 20;
                    left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
                    tooltip.classList.add('top');
                    break;
                case 'left':
                    top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
                    left = targetRect.left - tooltipRect.width - 20;
                    tooltip.classList.add('right');
                    break;
                case 'right':
                    top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
                    left = targetRect.right + 20;
                    tooltip.classList.add('left');
                    break;
            }

            // Ensure tooltip stays within viewport
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) top = 10;
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = window.innerHeight - tooltipRect.height - 10;
            }

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        function highlightElement(targetSelector) {
            // Remove previous highlights
            document.querySelectorAll('.onboarding-highlight').forEach(el => {
                el.classList.remove('onboarding-highlight', 'onboarding-pulse');
            });

            // Add highlight to current target
            const target = document.querySelector(targetSelector);
            if (target) {
                target.classList.add('onboarding-highlight', 'onboarding-pulse');
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function nextStep() {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                currentOnboardingStep++;
                showOnboardingStep();
            } else {
                finishOnboarding();
            }
        }

        function previousStep() {
            if (currentOnboardingStep > 0) {
                currentOnboardingStep--;
                showOnboardingStep();
            }
        }

        function skipOnboarding() {
            if (confirm('Tem certeza que deseja pular o tutorial? Voc√™ pode acess√°-lo novamente nas configura√ß√µes.')) {
                finishOnboarding();
            }
        }

        function finishOnboarding() {
            // Mark onboarding as completed
            localStorage.setItem('fluxodriverOnboardingCompleted', 'true');
            
            // Hide overlay
            document.getElementById('onboardingOverlay').style.display = 'none';
            
            // Remove all highlights
            document.querySelectorAll('.onboarding-highlight').forEach(el => {
                el.classList.remove('onboarding-highlight', 'onboarding-pulse');
            });
            
            // Show completion message
            setTimeout(() => {
                showAlert('üéâ Tutorial conclu√≠do! Agora voc√™ est√° pronto para usar o FLUXODRIVER e aumentar seus ganhos como motorista!');
            }, 500);
        }

        function resetOnboarding() {
            localStorage.removeItem('fluxodriverOnboardingCompleted');
            startOnboarding();
        }

        // Interactive Referral Network Visualization
        let networkData = { nodes: [], edges: [], stats: {} };
        let networkCanvas, networkCtx;
        let networkAnimation = true;
        let currentViewMode = 'tree';
        let networkScale = 1;
        let networkOffsetX = 0;
        let networkOffsetY = 0;
        let animationFrame;

        function initializeNetworkVisualization() {
            networkCanvas = document.getElementById('networkCanvas');
            if (!networkCanvas) return;

            networkCtx = networkCanvas.getContext('2d');
            setupNetworkCanvas();
            loadNetworkData();
            
            // Add event listeners
            networkCanvas.addEventListener('mousemove', handleNetworkMouseMove);
            networkCanvas.addEventListener('click', handleNetworkClick);
            networkCanvas.addEventListener('wheel', handleNetworkZoom);
        }

        function setupNetworkCanvas() {
            const container = networkCanvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            networkCanvas.width = rect.width - 32; // Account for padding
            networkCanvas.height = rect.height - 32;
            
            networkCtx.fillStyle = '#111827';
            networkCtx.fillRect(0, 0, networkCanvas.width, networkCanvas.height);
        }

        async function loadNetworkData() {
            try {
                const response = await fetch(`${API_BASE}/affiliate/network`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    networkData = await response.json();
                    updateNetworkStats(networkData.stats);
                    calculateNodePositions();
                    startNetworkAnimation();
                } else {
                    console.error('Failed to load network data');
                }
            } catch (error) {
                console.error('Error loading network data:', error);
            }
        }

        function updateNetworkStats(stats) {
            document.getElementById('networkSize').textContent = stats.networkSize || 0;
            document.getElementById('networkLevels').textContent = stats.networkLevels || 0;
            document.getElementById('networkEarnings').textContent = `R$ ${(stats.networkEarnings || 0).toFixed(2)}`;
            document.getElementById('networkGrowth').textContent = `+${stats.networkGrowth || 0}`;
        }

        function calculateNodePositions() {
            if (!networkData.nodes.length) return;

            switch (currentViewMode) {
                case 'tree':
                    calculateTreeLayout();
                    break;
                case 'circle':
                    calculateCircularLayout();
                    break;
                case 'force':
                    calculateForceLayout();
                    break;
            }
        }

        function calculateTreeLayout() {
            const centerX = networkCanvas.width / 2;
            const centerY = 50;
            const levelHeight = 80;
            
            // Group nodes by level
            const levelGroups = {};
            networkData.nodes.forEach(node => {
                if (!levelGroups[node.level]) levelGroups[node.level] = [];
                levelGroups[node.level].push(node);
            });

            // Position nodes level by level
            Object.keys(levelGroups).forEach(level => {
                const nodes = levelGroups[level];
                const levelY = centerY + (parseInt(level) * levelHeight);
                const startX = centerX - ((nodes.length - 1) * 100) / 2;

                nodes.forEach((node, index) => {
                    node.x = startX + (index * 100);
                    node.y = levelY;
                    node.targetX = node.x;
                    node.targetY = node.y;
                });
            });
        }

        function calculateCircularLayout() {
            const centerX = networkCanvas.width / 2;
            const centerY = networkCanvas.height / 2;
            const maxRadius = Math.min(centerX, centerY) - 50;

            networkData.nodes.forEach((node, index) => {
                if (node.isRoot) {
                    node.x = centerX;
                    node.y = centerY;
                } else {
                    const radius = (node.level * maxRadius) / Math.max(1, networkData.stats.networkLevels);
                    const angle = (index * 2 * Math.PI) / networkData.nodes.length;
                    node.x = centerX + radius * Math.cos(angle);
                    node.y = centerY + radius * Math.sin(angle);
                }
                node.targetX = node.x;
                node.targetY = node.y;
            });
        }

        function calculateForceLayout() {
            // Simple force-directed layout
            const centerX = networkCanvas.width / 2;
            const centerY = networkCanvas.height / 2;

            networkData.nodes.forEach((node, index) => {
                if (node.isRoot) {
                    node.x = centerX;
                    node.y = centerY;
                } else {
                    // Random initial positions that will be adjusted by forces
                    node.x = centerX + (Math.random() - 0.5) * 200;
                    node.y = centerY + (Math.random() - 0.5) * 200;
                }
                node.vx = 0;
                node.vy = 0;
                node.targetX = node.x;
                node.targetY = node.y;
            });

            // Apply force simulation
            simulateForces();
        }

        function simulateForces() {
            for (let i = 0; i < 100; i++) {
                // Repulsion between nodes
                networkData.nodes.forEach(node1 => {
                    networkData.nodes.forEach(node2 => {
                        if (node1 === node2) return;
                        
                        const dx = node1.x - node2.x;
                        const dy = node1.y - node2.y;
                        const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                        const force = 1000 / (distance * distance);
                        
                        node1.vx += (dx / distance) * force * 0.1;
                        node1.vy += (dy / distance) * force * 0.1;
                    });
                });

                // Attraction along edges
                networkData.edges.forEach(edge => {
                    const source = networkData.nodes.find(n => n.id === edge.source);
                    const target = networkData.nodes.find(n => n.id === edge.target);
                    
                    if (source && target) {
                        const dx = target.x - source.x;
                        const dy = target.y - source.y;
                        const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                        const force = distance * 0.01;
                        
                        source.vx += (dx / distance) * force;
                        source.vy += (dy / distance) * force;
                        target.vx -= (dx / distance) * force;
                        target.vy -= (dy / distance) * force;
                    }
                });

                // Update positions
                networkData.nodes.forEach(node => {
                    if (!node.isRoot) {
                        node.x += node.vx;
                        node.y += node.vy;
                        node.vx *= 0.9;
                        node.vy *= 0.9;
                    }
                });
            }
        }

        function startNetworkAnimation() {
            if (animationFrame) cancelAnimationFrame(animationFrame);
            
            function animate() {
                if (networkAnimation) {
                    drawNetwork();
                    animationFrame = requestAnimationFrame(animate);
                }
            }
            animate();
        }

        function drawNetwork() {
            // Clear canvas
            networkCtx.fillStyle = '#111827';
            networkCtx.fillRect(0, 0, networkCanvas.width, networkCanvas.height);

            // Save context for transformations
            networkCtx.save();
            networkCtx.translate(networkOffsetX, networkOffsetY);
            networkCtx.scale(networkScale, networkScale);

            // Draw edges
            networkData.edges.forEach(edge => {
                const source = networkData.nodes.find(n => n.id === edge.source);
                const target = networkData.nodes.find(n => n.id === edge.target);
                
                if (source && target) {
                    drawEdge(source, target, edge);
                }
            });

            // Draw nodes
            networkData.nodes.forEach(node => {
                drawNode(node);
            });

            networkCtx.restore();
        }

        function drawEdge(source, target, edge) {
            const gradient = networkCtx.createLinearGradient(source.x, source.y, target.x, target.y);
            gradient.addColorStop(0, '#3b82f6');
            gradient.addColorStop(1, '#8b5cf6');

            networkCtx.strokeStyle = gradient;
            networkCtx.lineWidth = Math.max(1, edge.earnings / 10);
            networkCtx.setLineDash([]);
            
            networkCtx.beginPath();
            networkCtx.moveTo(source.x, source.y);
            networkCtx.lineTo(target.x, target.y);
            networkCtx.stroke();

            // Draw arrow
            const angle = Math.atan2(target.y - source.y, target.x - source.x);
            const arrowLength = 10;
            const arrowX = target.x - Math.cos(angle) * 20;
            const arrowY = target.y - Math.sin(angle) * 20;

            networkCtx.beginPath();
            networkCtx.moveTo(arrowX, arrowY);
            networkCtx.lineTo(
                arrowX - arrowLength * Math.cos(angle - Math.PI / 6),
                arrowY - arrowLength * Math.sin(angle - Math.PI / 6)
            );
            networkCtx.moveTo(arrowX, arrowY);
            networkCtx.lineTo(
                arrowX - arrowLength * Math.cos(angle + Math.PI / 6),
                arrowY - arrowLength * Math.sin(angle + Math.PI / 6)
            );
            networkCtx.stroke();
        }

        function drawNode(node) {
            const radius = node.isRoot ? 20 : 15;
            let color;
            
            if (node.isRoot) {
                color = '#3b82f6'; // Blue for root
            } else if (node.level === 1) {
                color = '#10b981'; // Green for direct referrals
            } else if (node.level === 2) {
                color = '#f59e0b'; // Yellow for second level
            } else {
                color = '#8b5cf6'; // Purple for extended network
            }

            // Draw node circle
            networkCtx.fillStyle = color;
            networkCtx.beginPath();
            networkCtx.arc(node.x, node.y, radius, 0, 2 * Math.PI);
            networkCtx.fill();

            // Draw border
            networkCtx.strokeStyle = '#ffffff';
            networkCtx.lineWidth = 2;
            networkCtx.stroke();

            // Draw username
            networkCtx.fillStyle = '#ffffff';
            networkCtx.font = '12px sans-serif';
            networkCtx.textAlign = 'center';
            networkCtx.fillText(node.username, node.x, node.y + radius + 15);

            // Draw earnings if any
            if (node.earnings > 0) {
                networkCtx.fillStyle = '#10b981';
                networkCtx.font = '10px sans-serif';
                networkCtx.fillText(`R$ ${node.earnings.toFixed(2)}`, node.x, node.y + radius + 30);
            }
        }

        function handleNetworkMouseMove(event) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = (event.clientX - rect.left - networkOffsetX) / networkScale;
            const y = (event.clientY - rect.top - networkOffsetY) / networkScale;

            const hoveredNode = networkData.nodes.find(node => {
                const dx = x - node.x;
                const dy = y - node.y;
                const radius = node.isRoot ? 20 : 15;
                return Math.sqrt(dx * dx + dy * dy) <= radius;
            });

            const tooltip = document.getElementById('networkTooltip');
            if (hoveredNode) {
                tooltip.innerHTML = `
                    <div><strong>${hoveredNode.username}</strong></div>
                    <div>C√≥digo: ${hoveredNode.affiliateCode}</div>
                    <div>N√≠vel: ${hoveredNode.level}</div>
                    <div>Indica√ß√µes: ${hoveredNode.referralCount}</div>
                    <div>Ganhos: R$ ${hoveredNode.earnings.toFixed(2)}</div>
                `;
                tooltip.style.left = event.clientX + 10 + 'px';
                tooltip.style.top = event.clientY - 10 + 'px';
                tooltip.classList.remove('hidden');
            } else {
                tooltip.classList.add('hidden');
            }
        }

        function handleNetworkClick(event) {
            // Add click interactions if needed
        }

        function handleNetworkZoom(event) {
            event.preventDefault();
            const zoomFactor = event.deltaY > 0 ? 0.9 : 1.1;
            networkScale = Math.max(0.5, Math.min(3, networkScale * zoomFactor));
            drawNetwork();
        }

        function toggleNetworkAnimation() {
            networkAnimation = !networkAnimation;
            const button = document.getElementById('animationToggle');
            
            if (networkAnimation) {
                button.textContent = '‚è∏Ô∏è Pausar Anima√ß√£o';
                startNetworkAnimation();
            } else {
                button.textContent = '‚ñ∂Ô∏è Retomar Anima√ß√£o';
                if (animationFrame) cancelAnimationFrame(animationFrame);
            }
        }

        function resetNetworkView() {
            networkScale = 1;
            networkOffsetX = 0;
            networkOffsetY = 0;
            calculateNodePositions();
            drawNetwork();
        }

        function changeViewMode() {
            const select = document.getElementById('viewMode');
            currentViewMode = select.value;
            calculateNodePositions();
            drawNetwork();
        }

        function exportNetworkImage() {
            const link = document.createElement('a');
            link.download = 'rede-afiliados-fluxodriver.png';
            link.href = networkCanvas.toDataURL();
            link.click();
        }

        // Mobile Performance Optimizations
        let isLowPerformanceDevice = false;
        let requestQueue = [];
        let isProcessingQueue = false;
        let updateTimeouts = new Map();
        
        // Detect device performance capabilities
        function detectDevicePerformance() {
            const memoryInfo = performance.memory;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            isLowPerformanceDevice = 
                isMobile ||
                (memoryInfo && memoryInfo.usedJSHeapSize > 50000000) ||
                navigator.hardwareConcurrency < 4 ||
                window.innerWidth < 768;
            
            if (isLowPerformanceDevice) {
                console.log('Low performance device - enabling optimizations');
                
                // Disable expensive visual effects
                const style = document.createElement('style');
                style.textContent = `
                    .low-performance * {
                        transition: none !important;
                        animation: none !important;
                        transform: none !important;
                    }
                    .low-performance .bg-gradient-to-br,
                    .low-performance .bg-gradient-to-r {
                        background: #374151 !important;
                    }
                    .low-performance .shadow-lg {
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
                    }
                `;
                document.head.appendChild(style);
                document.body.classList.add('low-performance');
            }
        }

        // Throttle DOM updates
        function throttleUpdate(key, updateFunction, delay = 300) {
            if (updateTimeouts.has(key)) {
                clearTimeout(updateTimeouts.get(key));
            }
            
            updateTimeouts.set(key, setTimeout(() => {
                if (isLowPerformanceDevice) {
                    requestAnimationFrame(updateFunction);
                } else {
                    updateFunction();
                }
                updateTimeouts.delete(key);
            }, delay));
        }

        // Queue operations for low-performance devices
        function queueOperation(operation) {
            if (isLowPerformanceDevice) {
                requestQueue.push(operation);
                processQueue();
            } else {
                operation();
            }
        }

        async function processQueue() {
            if (isProcessingQueue || requestQueue.length === 0) return;
            
            isProcessingQueue = true;
            
            while (requestQueue.length > 0) {
                const operation = requestQueue.shift();
                try {
                    await operation();
                } catch (error) {
                    console.error('Operation failed:', error);
                }
                
                if (isLowPerformanceDevice && requestQueue.length > 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            isProcessingQueue = false;
        }

        // Initialize performance detection
        detectDevicePerformance();

        // Device Trial Status Variables
        let deviceTrialStatus = null;
        let affiliateOnlyMode = false;

        // Check device trial status
        async function checkDeviceTrialStatus() {
            try {
                const response = await fetch(`${API_BASE}/device/trial-status`);
                if (response.ok) {
                    deviceTrialStatus = await response.json();
                    affiliateOnlyMode = deviceTrialStatus.affiliateOnlyMode;
                    
                    if (affiliateOnlyMode) {
                        enforceAffiliateOnlyMode();
                    }
                    
                    return deviceTrialStatus;
                }
            } catch (error) {
                console.error('Error checking device trial status:', error);
                affiliateOnlyMode = false;
            }
            return null;
        }

        // Enforce affiliate-only mode after 48-hour trial
        function enforceAffiliateOnlyMode() {
            // Hide all sections except affiliate
            const sectionsToHide = ['recordsSection', 'reportsSection', 'finesSection', 'maintenanceSection'];
            sectionsToHide.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });

            // Hide navigation buttons for restricted sections
            const navButtonsToHide = ['recordsNavBtn', 'reportsNavBtn', 'finesNavBtn', 'maintenanceNavBtn'];
            navButtonsToHide.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.style.display = 'none';
                }
            });

            // Show affiliate section prominently
            const affiliateSection = document.getElementById('affiliateSection');
            if (affiliateSection) {
                affiliateSection.style.display = 'block';
            }

            // Show trial expired message
            showTrialExpiredMessage();
        }

        // Show trial expired message
        function showTrialExpiredMessage() {
            const message = document.createElement('div');
            message.className = 'bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-lg mb-4';
            message.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xl">‚è∞</span>
                    <div>
                        <h3 class="font-bold">Trial de 48 horas expirado</h3>
                        <p class="text-sm">Apenas a se√ß√£o de afiliados est√° dispon√≠vel. Assine para acessar todas as funcionalidades.</p>
                        <button onclick="showSubscribeModal()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            Assinar Agora - R$ 19,99
                        </button>
                    </div>
                </div>
            `;
            
            const mainPage = document.getElementById('mainPage');
            if (mainPage) {
                mainPage.insertBefore(message, mainPage.firstChild);
            }
        }

        // Enhanced load records with trial check
        async function loadRecords() {
            if (affiliateOnlyMode) {
                showAlert('Trial expirado. Assine para acessar registros.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.status === 403) {
                    const data = await response.json();
                    if (data.affiliateOnlyMode) {
                        affiliateOnlyMode = true;
                        enforceAffiliateOnlyMode();
                        showAlert('Trial de 48 horas expirado. Apenas se√ß√£o de afiliados dispon√≠vel.');
                        return;
                    }
                }

                if (response.ok) {
                    const records = await response.json();
                    displayRecords(records);
                } else {
                    console.error('Failed to fetch records');
                }
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }



        // Show subscription modal
        function showSubscribeModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4 border border-gray-600">
                    <h3 class="text-xl font-bold text-white mb-4">Assinar FLUXODRIVER</h3>
                    <div class="bg-green-900 p-4 rounded-lg mb-4">
                        <p class="text-green-200 font-semibold">R$ 19,99 por 90 dias</p>
                        <p class="text-green-300 text-sm">Acesso completo a todas as funcionalidades</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="subscribe()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            Assinar
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                            Fechar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Gamified Progress Tracker Functions (Optimized)
        async function loadProgressTracker() {
            try {
                const response = await fetch(`${API_BASE}/affiliate/progress`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const progress = await response.json();
                    updateProgressTracker(progress);
                }
            } catch (error) {
                console.error('Error loading progress tracker:', error);
            }
        }

        function updateProgressTracker(progress) {
            if (!progress) return;

            throttleUpdate('progress-tracker', () => {
                // Update level and XP
                const levelEl = document.getElementById('currentLevel');
                const xpEl = document.getElementById('currentXP');
                if (levelEl) levelEl.textContent = progress.level || 1;
                if (xpEl) xpEl.textContent = progress.experience || 0;
                
                // Update level icon based on level
                const levelIcon = document.getElementById('levelIcon');
                if (levelIcon) {
                    const levelIcons = {
                        1: '‚≠ê', 2: 'üåü', 3: '‚ú®', 4: 'üí´', 5: 'üèÜ',
                        6: 'üëë', 7: 'üíé', 8: 'üî•', 9: '‚ö°', 10: 'üöÄ'
                    };
                    levelIcon.textContent = levelIcons[progress.level] || '‚≠ê';
                }

                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                if (progressBar && progressText) {
                    const progressPercent = progress.progressPercent || 0;
                    progressBar.style.width = `${progressPercent}%`;
                    
                    if (progress.level >= 10) {
                        progressText.textContent = 'N√≠vel M√°ximo Alcan√ßado!';
                    } else {
                        progressText.textContent = `${progressPercent}% para n√≠vel ${progress.level + 1}`;
                    }
                }

                // Update streak
                const streakEl = document.getElementById('streakCount');
                if (streakEl) streakEl.textContent = progress.streak || 0;

                // Update badge count
                const badgeEl = document.getElementById('badgeCount');
                if (badgeEl) {
                    const badgeCount = progress.badges ? progress.badges.length : 0;
                    badgeEl.textContent = badgeCount;
                }

                // Show new badges notification
                if (progress.newBadges && progress.newBadges.length > 0) {
                    showNewBadgesNotification(progress.newBadges);
                }
            }, 200);
        }

        async function loadBadges() {
            queueOperation(async () => {
                try {
                    const response = await fetch(`${API_BASE}/affiliate/badges`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayBadges(data.badges);
                    }
                } catch (error) {
                    console.error('Error loading badges:', error);
                }
            });
        }

        function displayBadges(badges) {
            const container = document.getElementById('badgesContainer');
            if (!container) return;
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Limit badges displayed to prevent overflow on small screens
            const maxBadges = window.innerWidth < 768 ? 6 : badges.length;
            const displayBadges = badges.slice(0, maxBadges);

            displayBadges.forEach(badge => {
                const badgeElement = document.createElement('div');
                // Simplified classes for better performance
                badgeElement.className = badge.earned 
                    ? 'p-2 rounded-lg text-center bg-yellow-600 border border-yellow-500' 
                    : 'p-2 rounded-lg text-center bg-gray-700 border border-gray-600 opacity-50';
                
                badgeElement.innerHTML = `
                    <div class="text-lg mb-1">${badge.icon}</div>
                    <div class="text-xs text-white font-semibold">${badge.name}</div>
                `;

                fragment.appendChild(badgeElement);
            });
            
            // Single DOM update
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function showNewBadgesNotification(newBadges) {
            newBadges.forEach(badgeId => {
                const badgeData = getBadgeData(badgeId);
                if (badgeData) {
                    showAlert(`üèÖ Nova conquista desbloqueada: ${badgeData.name}!`);
                }
            });
        }

        function getBadgeData(badgeId) {
            const badges = {
                'first_referral': { name: 'Primeiro Indicado', icon: 'üéØ' },
                'streak_3': { name: 'Sequ√™ncia de 3', icon: 'üî•' },
                'streak_7': { name: 'Semana Perfeita', icon: '‚ö°' },
                'level_5': { name: 'Afiliado Experiente', icon: '‚≠ê' },
                'level_10': { name: 'Mestre Afiliado', icon: 'üëë' },
                'referrals_10': { name: 'Recrutador', icon: 'üë•' },
                'referrals_50': { name: 'Influenciador', icon: 'üåü' },
                'earnings_100': { name: 'Primeira Centena', icon: 'üí∞' },
                'earnings_500': { name: 'Empreendedor', icon: 'üíé' }
            };
            return badges[badgeId];
        }

        // PushinPay Integration Test
        async function testPushinPayIntegration() {
            try {
                const response = await fetch(`${API_BASE}/pushinpay/test`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                const statusDiv = document.getElementById('pushinPayStatus');
                const infoDiv = document.getElementById('pushinPayInfo');
                
                statusDiv.classList.remove('hidden');
                
                let statusHtml = '';
                
                if (data.status === 'success') {
                    statusHtml = `
                        <div class="bg-green-900 p-3 rounded-lg border border-green-600">
                            <h4 class="text-green-300 font-bold mb-2">‚úÖ Conex√£o Estabelecida</h4>
                            <div class="text-green-200 space-y-1">
                                <p><strong>Status:</strong> ${data.message}</p>
                                <p><strong>Pagamentos:</strong> ${data.canCreatePayments ? '‚úÖ Habilitado' : '‚ùå Desabilitado'}</p>
                                <p><strong>Saques:</strong> ${data.canProcessWithdrawals ? '‚úÖ Habilitado' : '‚ùå Desabilitado'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-900 p-3 rounded-lg border border-blue-600">
                            <h4 class="text-blue-300 font-bold mb-2">üîß Funcionalidades Dispon√≠veis</h4>
                            <div class="text-blue-200 space-y-1">
                                <p>‚úÖ Cria√ß√£o de PIX para assinaturas (R$ 19,99)</p>
                                <p>‚úÖ Comiss√µes autom√°ticas para afiliados (45%)</p>
                                <p>‚úÖ Saques via PIX (m√≠nimo R$ 10,00)</p>
                                <p>‚úÖ Webhooks para confirma√ß√£o de pagamentos</p>
                                <p>‚úÖ Split autom√°tico de comiss√µes</p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-900 p-3 rounded-lg border border-purple-600">
                            <h4 class="text-purple-300 font-bold mb-2">üìä Como Funciona</h4>
                            <div class="text-purple-200 space-y-1 text-xs">
                                <p><strong>1.</strong> Cliente paga assinatura (R$ 29,90)</p>
                                <p><strong>2.</strong> PushinPay divide automaticamente:</p>
                                <p>&nbsp;&nbsp;&nbsp;‚Ä¢ 55% para FLUXODRIVER (R$ 16,44)</p>
                                <p>&nbsp;&nbsp;&nbsp;‚Ä¢ 45% para afiliado (R$ 13,46)</p>
                                <p><strong>3.</strong> Afiliado recebe na chave PIX configurada</p>
                                <p><strong>4.</strong> Saque adicional dispon√≠vel a partir de R$ 10,00</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div class="bg-red-900 p-3 rounded-lg border border-red-600">
                            <h4 class="text-red-300 font-bold mb-2">‚ùå Erro na Conex√£o</h4>
                            <div class="text-red-200 space-y-1">
                                <p><strong>Status:</strong> ${data.message}</p>
                                <p><strong>C√≥digo:</strong> ${data.statusCode}</p>
                                <p><strong>Detalhes:</strong> ${data.error || 'Erro desconhecido'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-900 p-3 rounded-lg border border-yellow-600">
                            <h4 class="text-yellow-300 font-bold mb-2">üîß Poss√≠veis Solu√ß√µes</h4>
                            <div class="text-yellow-200 space-y-1 text-sm">
                                <p>‚Ä¢ Verificar se o token PushinPay est√° correto</p>
                                <p>‚Ä¢ Confirmar se a conta est√° ativa</p>
                                <p>‚Ä¢ Verificar conectividade com a internet</p>
                                <p>‚Ä¢ Contatar suporte PushinPay se necess√°rio</p>
                            </div>
                        </div>
                    `;
                }
                
                infoDiv.innerHTML = statusHtml;
                
                // Show status message
                showAlert(data.status === 'success' ? 
                    '‚úÖ PushinPay funcionando! Pagamentos autom√°ticos ativos.' : 
                    '‚ùå Problema na integra√ß√£o PushinPay detectado.'
                );
                
            } catch (error) {
                console.error('Error testing PushinPay:', error);
                showAlert('‚ùå Erro ao testar integra√ß√£o PushinPay');
            }
        }
    </script>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-nav lg:hidden" id="mobileNavigation">
        <div class="flex justify-around py-2">
            <button onclick="showMobileSection('records')" class="flex flex-col items-center py-2 px-4 touch-target mobile-nav-item" id="recordsNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-blue-400">
                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Registros</span>
            </button>
            
            <button onclick="showMobileSection('reports')" class="flex flex-col items-center py-2 px-4 touch-target mobile-nav-item" id="reportsNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-green-400">
                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Relat√≥rios</span>
            </button>
            
            <button onclick="showMobileSection('fines')" class="flex flex-col items-center py-2 px-4 touch-target mobile-nav-item" id="finesNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-red-400">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Multas</span>
            </button>
            
            <button onclick="showMobileSection('maintenance')" class="flex flex-col items-center py-2 px-4 touch-target mobile-nav-item" id="maintenanceNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-orange-400">
                    <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Manuten√ß√£o</span>
            </button>
            
            <button onclick="showMobileSection('affiliate')" class="flex flex-col items-center py-2 px-3 touch-target mobile-nav-item" id="affiliateNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-purple-400">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.999 1.999 0 0 0 18.05 7c-.8 0-1.54.5-1.85 1.26l-1.92 5.12c-.32.85.06 1.8.87 2.15L16 17v5h4z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Afiliados</span>
            </button>
            
            <button onclick="showMobileSection('settings')" class="flex flex-col items-center py-2 px-3 touch-target mobile-nav-item" id="settingsNavBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-gray-400">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span class="text-xs text-gray-300 mt-1">Config</span>
            </button>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay">
        <div id="onboardingProgress" class="onboarding-progress">
            Passo <span id="currentStep">1</span> de <span id="totalSteps">6</span>
        </div>
        <button id="onboardingSkip" class="onboarding-skip" onclick="skipOnboarding()">
            Pular Tutorial
        </button>
        <div id="onboardingTooltip" class="onboarding-tooltip">
            <h3 id="tooltipTitle" class="text-lg font-bold text-blue-400 mb-2"></h3>
            <p id="tooltipContent" class="text-gray-200 mb-4"></p>
            <div class="flex justify-between items-center">
                <button id="onboardingPrev" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500" onclick="previousStep()" style="display: none;">
                    Anterior
                </button>
                <button id="onboardingNext" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-auto" onclick="nextStep()">
                    Pr√≥ximo
                </button>
            </div>
        </div>
    </div>
</body>
</html>
